<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Smyslokoutek</title>

  <script>
    (function () {
      if (location.hostname.endsWith('.github.io')) {
        location.replace('https://admin.smyslokoutek.cz' + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <meta name="robots" content="noindex,nofollow">

  <style>
    :root{--ink:#111827;--muted:#6b7280;--card:#fff;--bg:#f9fafb;--brand:#111;--ok:#16a34a;--err:#dc2626}
    body{font-family:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1180px;margin:40px auto;padding:20px}
    .card{background:var(--card);padding:18px 20px;margin-bottom:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    h1{font-size:22px;margin:0 0 16px} h2{font-size:18px;margin:0 0 10px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;margin-top:4px;border:1px solid #e5e7eb;border-radius:8px;font-size:15px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer; touch-action:manipulation}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .error{color:var(--err);margin-top:8px}
    .ok{color:var(--ok);margin-top:8px}
    nav{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    nav button{background:#e5e7eb;color:#111} nav button.active{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:6px;text-align:left;vertical-align:top}
    th{background:#f3f4f6}
    tr:hover{background:#fafafa}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .sel{background:#fef3c7 !important}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff}
    .log{margin:10px 0;padding:10px;border-radius:8px;background:#fff;border:1px dashed #e5e7eb;font:12px/1.5 ui-monospace,Menlo,monospace;max-height:160px;overflow:auto;white-space:pre-wrap}

    /* ===== KAPACITN√ç RADAR UI ===== */
    .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:800;white-space:nowrap}
    .b-sold{background:#111;color:#fff}
    .b-high{background:#fee2e2;color:#991b1b}
    .b-ok{background:#e0e7ff;color:#1e3a8a}
    .b-low{background:#e5e7eb;color:#374151}
    .b-urg{background:#fef3c7;color:#92400e}
    .mono{font:12px/1.4 ui-monospace,Menlo,monospace;color:#374151}
    .radarCell{min-width:260px}
    .mini{display:block;margin-top:2px;color:#6b7280;font-size:12px}

    /* ===== AKƒåN√ç PANEL ===== */
    .panel{display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0 0}
    .panelRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;font-weight:700;font-size:12px}
    .actionList{margin-top:10px;display:grid;gap:10px}
    .actionItem{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
    .actionTop{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .actionTitle{font-weight:900}
    .actionMeta{color:#6b7280;font-size:12px}
    .actionBtns{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btnSm{margin-top:0;padding:8px 10px;border-radius:10px;font-size:12px}
    .btnGhost{background:#e5e7eb;color:#111}
    .btnOk{background:#111;color:#fff}
    .hidden{display:none!important}
    .smallSelect{padding:8px 10px;border-radius:10px;font-size:12px;border:1px solid #e5e7eb;background:#fff}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin ‚Äì Smyslokoutek</h1>

  <div id="loginCard" class="card">
    <div id="stepEmail">
      <label>Zadejte e-mail</label>
      <input id="email" type="email" placeholder="nap≈ô. info@smyslokoutek.cz" />
      <button id="sendOtpBtn">Poslat k√≥d</button>
      <div id="msgEmail" class="error"></div>
    </div>
    <div id="stepOtp" style="display:none">
      <label>Zadejte k√≥d z e-mailu</label>
      <input id="otp" type="text" placeholder="6m√≠stn√Ω k√≥d" />
      <button id="verifyOtpBtn">P≈ôihl√°sit</button>
      <div id="msgOtp" class="error"></div>
    </div>
    <div id="debug" class="log" style="display:none"></div>
  </div>

  <div id="app" style="display:none">
    <nav>
      <button data-tab="events" class="active">Term√≠ny</button>
      <button data-tab="coupons">Kupony</button>
      <button data-tab="bookings">Rezervace</button>
      <button data-tab="archive">Archiv</button>
      <div class="right" style="margin-left:auto"><button id="logoutBtn">Odhl√°sit</button></div>
    </nav>

    <div id="tab-events">
      <div class="grid">
        <div class="card">
          <h2>Seznam term√≠n≈Ø</h2>

          <!-- ‚úÖ Akƒçn√≠ panel: co ≈ôe≈°it -->
          <div class="panel">
            <div class="panelRow">
              <span class="chip">üéØ Co ≈ôe≈°it</span>

              <label class="muted" style="margin:0">Pohled</label>
              <select id="radar_view" class="smallSelect">
                <option value="acute">Akutn√≠ (10 dn√≠)</option>
                <option value="month" selected>Mƒõs√≠c (30 dn√≠)</option>
              </select>

              <span class="muted" id="radar_summary" style="margin-left:auto"></span>
            </div>

            <div id="radar_actions" class="actionList">
              <div class="muted">Naƒç√≠t√°m radar‚Ä¶</div>
            </div>
          </div>

          <div class="toolbar">
            <input id="f_from" type="date" />
            <input id="f_to" type="date" />
            <input id="f_q" placeholder="Hledat v ID / n√°zvu" style="flex:1" />
            <button id="ev_export">Export rezervac√≠</button>
            <button id="ev_archive">Archivovat</button>
          </div>
          <div class="muted">Kliknut√≠m vybere≈° term√≠n pro √∫pravu / export / archivaci.</div>
          <table id="eventsTable"><thead><tr>
            <th>ID</th><th>N√°zev</th><th>Start</th><th>Kap.</th><th>Obs.</th><th>Semafor</th><th>Doporuƒçen√≠</th><th>Cena</th><th>Sleva souroz.</th>
          </tr></thead><tbody></tbody></table>
        </div>

        <div class="card">
          <h2>Nov√Ω / √∫prava term√≠nu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Events</span>.</div>
          <label>ID</label><input id="ev_id" />
          <label>N√°zev</label><input id="ev_name" />
          <div class="row">
            <div><label>Start</label><input id="ev_start" type="datetime-local" /></div>
            <div><label>D√©lka (min)</label><input id="ev_duration" type="number" value="90" /></div>
          </div>
          <div class="row">
            <div><label>Kapacita</label><input id="ev_capacity" type="number" value="12" /></div>
            <div><label>Cena (Kƒç)</label><input id="ev_price" type="number" value="200" /></div>
          </div>
          <label>Sleva pro sourozence</label><input id="ev_sibling" type="number" value="20" />
          <div class="right"><button id="ev_reset">Vymazat</button><button id="ev_save">Ulo≈æit</button></div>
          <div id="ev_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-coupons" style="display:none">
      <div class="grid">
        <div class="card">
          <h2>Seznam kupon≈Ø</h2>
          <div class="right"><button id="cp_delete">Smazat / deaktivovat</button></div>
          <div class="muted">Klikni na kupon pro √∫pravu (a pro smaz√°n√≠/deaktivaci).</div>
          <table id="couponsTable"><thead><tr>
            <th>K√≥d</th><th>Typ</th><th>Hodnota</th><th>Max pou≈æ.</th><th>Vyƒçerp√°no</th><th>Min qty</th><th>Aktivn√≠</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Nov√Ω / √∫prava kuponu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Coupons</span>.</div>
          <label>K√≥d</label><input id="cp_code" />
          <div class="row">
            <div><label>Typ</label>
              <select id="cp_type">
                <option value="amount">amount (Kƒç)</option>
                <option value="percent">percent (%)</option>
                <option value="free">free (poƒçet m√≠st)</option>
                <option value="bogo">bogo (1+1, qty=2)</option>
              </select>
            </div>
            <div><label>Hodnota</label><input id="cp_value" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Max. pou≈æit√≠</label><input id="cp_maxuses" type="number" /></div>
            <div><label>Min. qty</label><input id="cp_minqty" type="number" /></div>
          </div>
          <label>Ud√°losti (id, * = v≈°echny)</label><input id="cp_events" />
          <div class="row">
            <div><label>Stack se sourozenci?</label><select id="cp_stack"><option value="true">TRUE</option><option value="false">FALSE</option></select></div>
            <div><label>Max sleva (jen pro %)</label><input id="cp_cap" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Platnost od</label><input id="cp_from" type="date" /></div>
            <div><label>Platnost do</label><input id="cp_to" type="date" /></div>
          </div>
          <label>Aktivn√≠</label><select id="cp_active"><option value="1">1</option><option value="0">0</option></select>
          <label>Pozn√°mka</label><input id="cp_note" />
          <div class="right"><button id="cp_reset">Vymazat</button><button id="cp_save">Ulo≈æit</button></div>
          <div id="cp_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-bookings" style="display:none">
      <div class="card">
        <h2>Rezervace</h2>
        <div class="toolbar">
          <select id="b_ev" style="min-width:320px"><option value="">(v≈°echny ud√°losti)</option></select>
          <input id="b_from" type="date" />
          <input id="b_to" type="date" />
          <input id="b_q" placeholder="Hledat (jm√©no, e-mail, tel.)" style="flex:1" />
          <button id="b_export">Export aktu√°ln√≠ho v√Ωbƒõru</button>
        </div>
        <table id="bookingsTable"><thead><tr>
          <th>TS</th><th>Event</th><th>Jm√©no</th><th>Email</th><th>Tel</th><th>M√≠st</th><th>Platba</th><th>Celkem</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h2>Upravit rezervaci</h2>
        <div class="muted">Klikni v tabulce na ≈ô√°dek ‚Äì z√°znam se naƒçte sem.</div>
        <div class="row">
          <div><label>Jm√©no</label><input id="bk_name"/></div>
          <div><label>Qty</label><input id="bk_qty" type="number" min="0"/></div>
        </div>
        <div class="row">
          <div><label>Telefon</label><input id="bk_phone"/></div>
          <div><label>E-mail</label><input id="bk_email"/></div>
        </div>
        <label>Platba</label>
        <select id="bk_payment"><option value="cash">cash</option><option value="transfer">transfer</option></select>
        <div class="right"><button id="bk_save">Ulo≈æit zmƒõny</button></div>
        <div id="bk_msg" class="error"></div>
      </div>
    </div>

    <div id="tab-archive" style="display:none">
      <div class="card">
        <h2>Archiv term√≠n≈Ø</h2>
        <table id="archiveTable"><thead><tr>
          <th>ID</th><th>N√°zev</th><th>Start</th><th>Kapacita</th><th>Obsazeno</th><th>Cena</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== KONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzAJh9wVawvTfLUfsi7qqtkxyaT5Hpm69gyAlwNROW8N5S-MEIrOSW541caGaRQ5ysl_g/exec';
if(!API_URL || !API_URL.includes('/exec')){ alert('Chyb√≠ platn√° API_URL!'); }

/* ===== HELPERY ===== */
const el = id => document.getElementById(id);
const errEmail = el('msgEmail'), errOtp = el('msgOtp'), dbg = el('debug');
function authQuery(){
  const t = localStorage.getItem('adm_token') || '';
  return 'Authorization=' + encodeURIComponent('Bearer ' + t);
}
function setSel(tr, tableSel){
  document.querySelectorAll(`${tableSel} tbody tr`).forEach(x=>x.classList.remove('sel'));
  tr.classList.add('sel');
}
function logDbg(obj){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }
  catch{ dbg.textContent = String(obj); }
}

/* ===== FETCH WRAPPER (iOS hardening) ===== */
function withCacheBust(url){
  const u = new URL(url, location.href);
  u.searchParams.set('_', String(Date.now()));
  return u.toString();
}
async function apiFetch(url, opts={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), opts.timeoutMs || 20000);

  try{
    const r = await fetch(withCacheBust(url), {
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow',
      ...opts,
      headers: { 'Content-Type':'text/plain; charset=utf-8', ...(opts.headers||{}) },
      signal: controller.signal
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{ j = { ok:false, error:'Neplatn√° odpovƒõƒè serveru', raw: txt }; }
    return j;
  } finally {
    clearTimeout(t);
  }
}

/* ===== KAPACITN√ç RADAR (akƒçn√≠) =====
   C√≠l: man≈æelka nechce "30 dn√≠: 0 m√≠st".
   Chce: "Chyb√≠ X m√≠st, do term√≠nu Y dn√≠, co udƒõlat".
*/
const RADAR_WINDOW_DAYS = 30;  // poƒç√≠t√°me tempo za posledn√≠ch 30 dn√≠
const VIEW_ACUTE_DAYS = 10;    // akutn√≠ pohled = term√≠ny do 10 dn√≠
const VIEW_MONTH_DAYS = 30;    // mƒõs√≠ƒçn√≠ pohled = term√≠ny do 30 dn√≠

// prahy pro SEMAFOR (bez historie a bez Apps Script zmƒõn)
const THRESH = {
  CRITICAL_DAYS: 7,    // do 7 dn√≠
  SOON_DAYS: 14,       // do 14 dn√≠
  LOW_PCT_7: 0.40,     // <40% obsazen√≠ do 7 dn√≠ = krizov√©
  LOW_PCT_14: 0.25,    // <25% obsazen√≠ do 14 dn√≠ = tlaƒçit
  ZERO_AFTER_HOURS: 48 // 0 rezervac√≠ po 48h od vytvo≈ôen√≠/zaƒç√°tku okna => hl√≠dat (fallback)
};

function daysDiff_(a, b){
  const ms = 24*60*60*1000;
  return Math.round((b - a)/ms);
}
function clamp_(n, a, b){ return Math.max(a, Math.min(b, n)); }
function escapeHtml_(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function badge_(cls, text, title=''){
  const t = title ? ` title="${escapeHtml_(title)}"` : '';
  return `<span class="badge ${cls}"${t}>${text}</span>`;
}

function formatCZDate_(isoOrStr){
  try{
    const d = new Date(isoOrStr);
    if(isNaN(d.getTime())) return String(isoOrStr||'');
    return d.toLocaleString('cs-CZ', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }catch{ return String(isoOrStr||''); }
}
function pad2_(n){ return String(n).padStart(2,'0'); }
function formatShort_(isoOrStr){
  try{
    const d = new Date(isoOrStr);
    if(isNaN(d.getTime())) return String(isoOrStr||'');
    return `${pad2_(d.getDate())}.${pad2_(d.getMonth()+1)}. ${pad2_(d.getHours())}:${pad2_(d.getMinutes())}`;
  }catch{ return String(isoOrStr||''); }
}

function buildPromoText_(ev){
  const d = new Date(ev.start);
  const dateLine = !isNaN(d.getTime())
    ? `${pad2_(d.getDate())}.${pad2_(d.getMonth()+1)}.${d.getFullYear()} v ${pad2_(d.getHours())}:${pad2_(d.getMinutes())}`
    : String(ev.start||'');
  const left = Math.max(0, Number(ev.capacity||0) - Number(ev.taken||0));
  const name = String(ev.name||'');
  // link nezn√°me, nech√°me generick√© (man≈æelka vlo≈æ√≠, nebo dopln√≠≈° pozdƒõji)
  return `üìå ${name}\nüóìÔ∏è ${dateLine}\n‚úÖ Voln√° m√≠sta: ${left}\n\nRezervace: (vlo≈æit odkaz)\n`;
}

async function fetchBookingsRange_(fromISO, toISO){
  let page = 1;
  const pageSize = 200;
  let all = [];
  while(true){
    const p = new URLSearchParams({
      action:'admin_bookings_list',
      from: fromISO,
      to: toISO,
      page: String(page),
      pageSize: String(pageSize)
    });
    const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠ rezervac√≠ pro radar');
    all = all.concat(j.items||[]);
    if((j.items||[]).length < pageSize) break;
    page++;
    if(page > 15) break;
  }
  return all;
}

function computeRadar_(events, bookings){
  // bookings: souƒçet qty za okno
  const byEv = new Map();
  bookings.forEach(b=>{
    const id = String(b.eventId||'');
    const qty = Number(b.qty||1);
    byEv.set(id, (byEv.get(id)||0) + qty);
  });

  const now = new Date();
  const map = {};
  events.forEach(ev=>{
    const cap = Number(ev.capacity||0);
    const taken = Number(ev.taken||0);
    const left = Math.max(0, cap - taken);

    const start = new Date(ev.start);
    const daysToStart = clamp_(daysDiff_(now, start), -9999, 9999);

    const windowSum = Number(byEv.get(String(ev.id))||0);
    const velocity = windowSum / RADAR_WINDOW_DAYS; // m√≠sta/den (posledn√≠ch 30 dn√≠)
    const etaDays = (velocity > 0) ? (left / velocity) : null;

    const pct = cap > 0 ? (taken / cap) : 0;

    // SEMAFOR (prim√°rnƒõ podle ƒçasu a obsazen√≠ ‚Äì srozumitelnƒõj≈°√≠)
    let status = 'OK';     // OK / WATCH / PUSH / CRITICAL / SOLD
    let cls = 'b-ok';
    let headline = '‚úÖ OK';
    let advice = 'Zat√≠m v normƒõ.';
    let action = '≈Ω√°dn√° akce.';

    if(left <= 0){
      status='SOLD'; cls='b-sold'; headline='VYPROD√ÅNO'; advice='Hotovo.'; action='‚Äî';
    } else if(daysToStart <= THRESH.CRITICAL_DAYS && pct < THRESH.LOW_PCT_7){
      status='CRITICAL'; cls='b-high'; headline='üî¥ KRIZOV√â';
      advice = `Do term√≠nu ${daysToStart} dn√≠, chyb√≠ ${left} m√≠st.`;
      action = 'D√°t dnes post + story (p≈ôipomenout).';
    } else if(daysToStart <= THRESH.SOON_DAYS && pct < THRESH.LOW_PCT_14){
      status='PUSH'; cls='b-urg'; headline='üü† TLAƒåIT';
      advice = `Do term√≠nu ${daysToStart} dn√≠, chyb√≠ ${left} m√≠st.`;
      action = 'Napl√°novat p≈ôipomenut√≠ (story / FB).';
    } else if(pct < 0.15 && daysToStart > 0){
      status='WATCH'; cls='b-low'; headline='üü° HL√çDAT';
      advice = `Zat√≠m slab≈°√≠ start, chyb√≠ ${left} m√≠st.`;
      action = 'Jemnƒõ p≈ôipomenout (1√ó p≈ô√≠spƒõvek).';
    } else {
      // OK (p≈ô√≠padnƒõ p≈ôid√°me "rychl√© plnƒõn√≠" podle ETA)
      if(etaDays != null && daysToStart > 0 && etaDays <= daysToStart * 1.1){
        cls='b-high'; headline='üî• PLN√ç SE'; advice=`Tempo dobr√©, chyb√≠ ${left} m√≠st.`; action='Sp√≠≈° jen udr≈æet.';
      }
    }

    const detail = [
      `Obsazen√≠: ${taken}/${cap} (${Math.round(pct*100)}%)`,
      `Volno: ${left}`,
      `Do startu: ${daysToStart} dn√≠`,
      `Tempo (30 dn√≠): ${windowSum} m√≠st (${velocity.toFixed(2)}/den)`,
      etaDays!=null ? `ETA vyprod√°n√≠: ~${Math.ceil(etaDays)} dn√≠` : `ETA vyprod√°n√≠: nezn√°m√©`
    ].join('\n');

    map[String(ev.id)] = {
      status,
      cls,
      headline,
      advice,
      action,
      left,
      cap,
      taken,
      pct,
      daysToStart,
      velocityPerDay: velocity,
      windowSum,
      etaDays,
      semaforHtml: badge_(cls, headline.replace('‚úÖ ','').replace('üî• ',''), detail),
      radarHtml:
        badge_(cls, headline, detail) +
        `<span class="mini">${advice}<br><strong>Doporuƒçen√≠:</strong> ${action}</span>`
    };
  });

  return map;
}

function filterUpcoming_(events, maxDays){
  const now = new Date();
  return (events||[]).filter(ev=>{
    const d = new Date(ev.start);
    if(isNaN(d.getTime())) return false;
    const dt = daysDiff_(now, d);
    return dt >= 0 && dt <= maxDays;
  }).sort((a,b)=> new Date(a.start) - new Date(b.start));
}

function buildActionItems_(events, radarMap, view){
  const maxDays = (view === 'acute') ? VIEW_ACUTE_DAYS : VIEW_MONTH_DAYS;
  const upcoming = filterUpcoming_(events, maxDays);

  // prioritizace: CRITICAL -> PUSH -> WATCH
  const priority = { CRITICAL: 0, PUSH: 1, WATCH: 2, OK: 9, SOLD: 10 };

  const items = upcoming
    .map(ev => ({ ev, r: radarMap[String(ev.id)] }))
    .filter(x => x.r && ['CRITICAL','PUSH','WATCH'].includes(x.r.status))
    .sort((a,b)=>{
      const pa = priority[a.r.status] ?? 9;
      const pb = priority[b.r.status] ?? 9;
      if(pa !== pb) return pa - pb;
      return a.r.daysToStart - b.r.daysToStart;
    })
    .slice(0, 6); // max 6 √∫kol≈Ø

  return { items, maxDays, totalUpcoming: upcoming.length };
}

function renderActionPanel_(events, radarMap){
  const view = (el('radar_view')?.value) || 'month';
  const box = el('radar_actions');
  const sum = el('radar_summary');

  if(!box || !sum){ return; }

  const { items, maxDays, totalUpcoming } = buildActionItems_(events, radarMap, view);

  // summary
  const c = items.filter(x=>x.r.status==='CRITICAL').length;
  const p = items.filter(x=>x.r.status==='PUSH').length;
  const w = items.filter(x=>x.r.status==='WATCH').length;
  sum.textContent = `V√Ωhled ${maxDays} dn√≠: ${totalUpcoming} term√≠n≈Ø ‚Ä¢ √∫koly: ${c}√ó kritick√©, ${p}√ó tlaƒçit, ${w}√ó hl√≠dat`;

  if(!items.length){
    box.innerHTML = `<div class="muted">‚úÖ Nic kritick√©ho. Vypad√° to v pohodƒõ.</div>`;
    return;
  }

  box.innerHTML = '';
  items.forEach(({ev, r})=>{
    const left = Math.max(0, Number(ev.capacity||0) - Number(ev.taken||0));
    const promo = buildPromoText_(ev);

    const item = document.createElement('div');
    item.className = 'actionItem';

    item.innerHTML = `
      <div class="actionTop">
        <div>
          <div class="actionTitle">${r.radarHtml}</div>
          <div class="actionMeta">${escapeHtml_(ev.name||'')} ‚Ä¢ ${escapeHtml_(formatShort_(ev.start))} ‚Ä¢ chyb√≠ <strong>${left}</strong> m√≠st</div>
        </div>
        <div class="actionBtns">
          <button class="btnSm btnGhost" data-act="copy" data-id="${escapeHtml_(ev.id)}">Zkop√≠rovat text (IG/FB)</button>
          <button class="btnSm btnGhost" data-act="pick" data-id="${escapeHtml_(ev.id)}">Vybrat term√≠n</button>
        </div>
      </div>
    `;
    item.querySelector('[data-act="copy"]').onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(promo);
        alert('Zkop√≠rov√°no do schr√°nky ‚úÖ');
      }catch{
        // fallback: prompt
        prompt('Zkop√≠ruj text:', promo);
      }
    };
    item.querySelector('[data-act="pick"]').onclick = ()=>{
      // najdi ≈ô√°dek v tabulce a vyber
      const tr = document.querySelector(`#eventsTable tbody tr[data-eid="${CSS.escape(String(ev.id))}"]`);
      if(tr){ tr.scrollIntoView({behavior:'smooth', block:'center'}); tr.click(); }
    };

    box.appendChild(item);
  });
}

/* ===== OTP ===== */
el('sendOtpBtn').onclick = async ()=>{
  const email = el('email').value.trim().toLowerCase();
  errEmail.textContent=''; logDbg('');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errEmail.textContent='Zadejte platn√Ω e-mail.'; return; }
  const b=el('sendOtpBtn'); b.disabled=true; b.textContent='Odes√≠l√°m‚Ä¶';
  try{
    const j = await apiFetch(API_URL+'?action=auth_request_otp', { method:'POST', body: JSON.stringify({email}) });
    logDbg(j);
    if(!j.ok){ errEmail.textContent=j.error||'Nepoda≈ôilo se odeslat k√≥d.'; return; }
    el('stepEmail').style.display='none';
    el('stepOtp').style.display='block';
    errOtp.textContent='K√≥d odesl√°n (plat√≠ 5 min).';
  }catch(e){
    errEmail.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }finally{
    setTimeout(()=>{ b.disabled=false; b.textContent='Poslat k√≥d'; }, 30000);
  }
};
el('verifyOtpBtn').onclick = async ()=>{
  const email=el('email').value.trim().toLowerCase();
  const code=el('otp').value.trim();
  errOtp.textContent=''; logDbg('');
  try{
    const j = await apiFetch(API_URL+'?action=auth_verify_otp', { method:'POST', body: JSON.stringify({email,code}) });
    logDbg(j);
    if(!j.ok){ errOtp.textContent=j.error||'Chybn√Ω k√≥d.'; return; }
    localStorage.setItem('adm_token', j.token);
    startApp();
  }catch(e){
    errOtp.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }
};

/* ===== NAV ===== */
document.querySelectorAll('nav button[data-tab]').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('[id^=tab-]').forEach(x=>x.style.display='none');
    el('tab-'+b.dataset.tab).style.display='block';
  };
});
el('logoutBtn').onclick = ()=>{ localStorage.removeItem('adm_token'); location.reload(); };

/* ===== STATE ===== */
let SELECTED_EVENT_ID='';
let SELECTED_COUPON_CODE='';
let BOOKING_KEY=null;

/* ===== EVENTS ===== */
['f_from','f_to','f_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadEvents());
});

if(el('radar_view')){
  el('radar_view').addEventListener('change', ()=>{ if(window.__LAST_EVENTS && window.__LAST_RADAR){ renderActionPanel_(window.__LAST_EVENTS, window.__LAST_RADAR); } });
}

el('ev_export').onclick = ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(SELECTED_EVENT_ID)+'&'+authQuery();
};
el('ev_archive').onclick = async ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  if(!confirm('Archivovat vybran√Ω term√≠n?')) return;

  const j = await apiFetch(API_URL+'?action=admin_event_archive&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({id:SELECTED_EVENT_ID})
  });
  if(!j.ok){ alert(j.error||'Archivace selhala'); return; }
  SELECTED_EVENT_ID='';
  await loadEvents();
  alert('Term√≠n p≈ôesunut do archivu.');
};

async function loadEvents(){
  const box=el('eventsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="9">Naƒç√≠t√°m‚Ä¶</td></tr>';
  if(el('radar_actions')) el('radar_actions').innerHTML = `<div class="muted">Naƒç√≠t√°m radar‚Ä¶</div>`;

  try{
    const p=new URLSearchParams({
      action:'admin_events_list',
      from: el('f_from').value||'',
      to: el('f_to').value||'',
      q: el('f_q').value||''
    });
    const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');

    const events = j.items || [];
    window.__LAST_EVENTS = events;

    renderEvents(events); // rychle bez radaru

    // radar: tempo za posledn√≠ch 30 dn√≠
    const now = new Date();
    const from = new Date(now.getTime() - RADAR_WINDOW_DAYS*24*60*60*1000);
    const fromISO = from.toISOString().slice(0,10);
    const toISO = now.toISOString().slice(0,10);

    const bookings = await fetchBookingsRange_(fromISO, toISO);
    const radarMap = computeRadar_(events, bookings);
    window.__LAST_RADAR = radarMap;

    renderEvents(events, radarMap);       // tabulka se semaforem + doporuƒçen√≠m
    renderActionPanel_(events, radarMap); // akƒçn√≠ panel naho≈ôe
  }catch(e){
    box.innerHTML=`<tr><td colspan="9" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}

function renderEvents(items, radarMap = null){
  const box=el('eventsTable').querySelector('tbody');
  SELECTED_EVENT_ID='';
  if(!items.length){ box.innerHTML='<tr><td colspan="9">≈Ω√°dn√© term√≠ny.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(ev=>{
    const tr=document.createElement('tr');
    tr.dataset.eid = String(ev.id);

    const r = radarMap ? radarMap[String(ev.id)] : null;

    const semafor = r ? `${badge_(r.cls, r.headline)}`
                      : `${badge_('b-low','RADAR‚Ä¶')}`;

    const advice = r
      ? `<div class="radarCell">${escapeHtml_(r.advice)}<span class="mini"><strong>Doporuƒçen√≠:</strong> ${escapeHtml_(r.action)}</span></div>`
      : `<span class="muted">Naƒç√≠t√°m‚Ä¶</span>`;

    tr.innerHTML=
      `<td>${escapeHtml_(ev.id)}</td>
       <td>${escapeHtml_(ev.name)}</td>
       <td>${escapeHtml_(formatCZDate_(ev.start))}</td>
       <td>${escapeHtml_(ev.capacity)}</td>
       <td>${escapeHtml_(ev.taken)}</td>
       <td>${semafor}</td>
       <td>${advice}</td>
       <td>${escapeHtml_(ev.price)}</td>
       <td>${escapeHtml_(ev.sibling_discount)}</td>`;

    const onPick = ()=>{
      setSel(tr,'#eventsTable');
      SELECTED_EVENT_ID=ev.id;
      fillEventForm(ev);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true}); // iOS fallback

    box.appendChild(tr);
  });
}

function fillEventForm(ev){
  el('ev_id').value=ev.id||'';
  el('ev_name').value=ev.name||'';
  try{
    const d=new Date(ev.start);
    const pad=n=>String(n).padStart(2,'0');
    el('ev_start').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{}
  el('ev_duration').value=ev.duration||90;
  el('ev_capacity').value=ev.capacity||0;
  el('ev_price').value=ev.price||0;
  el('ev_sibling').value=ev.sibling_discount||0;
}
el('ev_save').onclick = async ()=>{
  const msg=el('ev_msg');
  msg.className='error';
  msg.textContent='';

  if(!el('ev_name').value.trim()){ msg.textContent='Vypl≈à n√°zev.'; return; }
  if(!el('ev_start').value){ msg.textContent='Vypl≈à datum a ƒças.'; return; }

  const payload={
    id: el('ev_id').value.trim(),
    name: el('ev_name').value.trim(),
    start: el('ev_start').value,
    duration: Number(el('ev_duration').value||90),
    capacity: Number(el('ev_capacity').value||0),
    price: Number(el('ev_price').value||0),
    sibling_discount: Number(el('ev_sibling').value||0)
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_event_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadEvents();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== COUPONS ===== */
el('cp_delete').onclick = async ()=>{
  if(!SELECTED_COUPON_CODE){ alert('Vyber kupon.'); return; }
  const hard=confirm('Smazat trvale? (OK = hard delete, Zru≈°it = deaktivovat)');
  const j = await apiFetch(API_URL+'?action=admin_coupon_delete&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({code:SELECTED_COUPON_CODE,hard})
  });
  if(!j.ok){ alert(j.error||'Maz√°n√≠ selhalo'); return; }
  SELECTED_COUPON_CODE='';
  await loadCoupons();
  alert(hard?'Kupon smaz√°n.':'Kupon deaktivov√°n.');
};
async function loadCoupons(){
  const box=el('couponsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="7">Naƒç√≠t√°m‚Ä¶</td></tr>';
  try{
    const j = await apiFetch(API_URL+'?action=admin_coupons_list&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');
    renderCoupons(j.items||[]);
  }catch(e){
    box.innerHTML=`<tr><td colspan="7" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}
function renderCoupons(items){
  const box=el('couponsTable').querySelector('tbody');
  SELECTED_COUPON_CODE='';
  if(!items.length){ box.innerHTML='<tr><td colspan="7">≈Ω√°dn√© kupony.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.code}</td><td>${c.type}</td><td>${c.value}</td><td>${c.max_uses}</td><td>${c.used}</td><td>${c.min_qty}</td><td>${c.active}</td>`;

    const onPick = ()=>{
      setSel(tr,'#couponsTable');
      SELECTED_COUPON_CODE=c.code;
      fillCouponForm(c);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});

    box.appendChild(tr);
  });
}
function fillCouponForm(c){
  el('cp_code').value=c.code||'';
  el('cp_type').value=c.type||'amount';
  el('cp_value').value=c.value||0;
  el('cp_maxuses').value=c.max_uses||0;
  el('cp_minqty').value=c.min_qty||1;
  el('cp_events').value=c.events||'*';
  el('cp_stack').value=c.stack_with_siblings?'true':'false';
  el('cp_cap').value=c.max_discount||'';
  el('cp_from').value=(c.valid_from||'').split('T')[0]||'';
  el('cp_to').value=(c.valid_to||'').split('T')[0]||'';
  el('cp_active').value=(c.active?1:0);
  el('cp_note').value=c.note||'';
}
el('cp_save').onclick = async ()=>{
  const msg=el('cp_msg');
  msg.className='error';
  msg.textContent='';
  if(!el('cp_code').value.trim()){ msg.textContent='Vypl≈à k√≥d.'; return; }

  const payload={
    code: el('cp_code').value.trim().toUpperCase(),
    type: el('cp_type').value,
    value: Number(el('cp_value').value||0),
    max_uses: Number(el('cp_maxuses').value||0),
    min_qty: Number(el('cp_minqty').value||1),
    events: el('cp_events').value.trim()||'*',
    stack_with_siblings:(el('cp_stack').value==='true'),
    max_discount: el('cp_cap').value?Number(el('cp_cap').value):null,
    valid_from: el('cp_from').value||null,
    valid_to: el('cp_to').value||null,
    active: Number(el('cp_active').value||1),
    note: el('cp_note').value||''
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_coupon_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadCoupons();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== BOOKINGS ===== */
el('b_export').onclick = ()=>{
  const v=el('b_ev').value;
  if(!v){ alert('Vyber ud√°lost v rozbalovaƒçce.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(v)+'&'+authQuery();
};
['b_ev','b_from','b_to','b_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadBookings());
});

async function loadEventDropdown(){
  const j = await apiFetch(API_URL+'?action=admin_events_dropdown', { method:'GET' });
  if(j.ok){
    const sel=el('b_ev');
    sel.innerHTML='<option value="">(v≈°echny ud√°losti)</option>';
    (j.items||[]).forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id;
      o.textContent=it.label;
      sel.appendChild(o);
    });
  }
}
async function loadBookings(){
  const tb=el('bookingsTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="8">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const p=new URLSearchParams({
    action:'admin_bookings_list',
    eventId: el('b_ev').value||'',
    from: el('b_from').value||'',
    to: el('b_to').value||'',
    q: el('b_q').value||'',
    page:'1',
    pageSize:'200'
  });

  const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="8" style="color:#dc2626">'+(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="8">≈Ω√°dn√© rezervace.</td></tr>';
    return;
  }

  (j.items||[]).forEach(bk=>{
    const tr=document.createElement('tr');

    let tsIso = '';
    try{
      const d = new Date(bk.ts);
      tsIso = !isNaN(d.getTime()) ? d.toISOString() : String(bk.ts||'');
    }catch{ tsIso = String(bk.ts||''); }

    tr.innerHTML=`<td>${new Date(bk.ts).toLocaleString('cs-CZ')}</td><td>${bk.eventId}</td><td>${bk.name||''}</td>
      <td>${bk.email||''}</td><td>${bk.phone||''}</td><td>${bk.qty}</td><td>${bk.payment||''}</td><td>${bk.total||0}</td>`;

    const onPick = ()=>{
      setSel(tr,'#bookingsTable');
      BOOKING_KEY = { ts: tsIso, eventId: bk.eventId };

      el('bk_name').value=bk.name||'';
      el('bk_qty').value=bk.qty||0;
      el('bk_phone').value=bk.phone||'';
      el('bk_email').value=bk.email||'';
      el('bk_payment').value=bk.payment||'cash';
    };

    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});

    tb.appendChild(tr);
  });
}
el('bk_save').onclick = async ()=>{
  const msg=el('bk_msg');
  msg.className='error';
  msg.textContent='';
  if(!BOOKING_KEY){ msg.textContent='Nen√≠ vybran√Ω z√°znam.'; return; }

  const payload={
    ts: BOOKING_KEY.ts,
    eventId: BOOKING_KEY.eventId,
    name: el('bk_name').value.trim(),
    phone: el('bk_phone').value.trim(),
    email: el('bk_email').value.trim(),
    qty: Number(el('bk_qty').value||0),
    paymentMethod: el('bk_payment').value
  };

  const j = await apiFetch(API_URL+'?action=admin_booking_update&'+authQuery(), {
    method:'POST',
    body: JSON.stringify(payload)
  });

  if(!j.ok){
    msg.className='error';
    msg.textContent=j.error||'Ulo≈æen√≠ selhalo';
    return;
  }

  msg.className='ok';
  msg.textContent='Ulo≈æeno.';
  await loadBookings();
};

/* ===== ARCHIVE ===== */
async function loadArchive(){
  const tb=el('archiveTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="6">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const j = await apiFetch(API_URL+'?action=admin_events_archive&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="6" style="color:#dc2626">'+(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="6">Archiv je pr√°zdn√Ω.</td></tr>';
    return;
  }

  (j.items||[]).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ev.id}</td><td>${ev.name}</td><td>${ev.start}</td><td>${ev.capacity}</td><td>${ev.taken}</td><td>${ev.price}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== START ===== */
async function startApp(){
  try{
    const j = await apiFetch(API_URL+'?action=session&'+authQuery(), { method:'GET' });
    if(!j.ok){ localStorage.removeItem('adm_token'); location.reload(); return; }
    el('loginCard').style.display='none';
    el('app').style.display='block';
    await Promise.all([loadEventDropdown(), loadEvents(), loadCoupons(), loadBookings(), loadArchive()]);
  }catch(e){
    logDbg(String(e));
    localStorage.removeItem('adm_token');
    location.reload();
  }
}
if(localStorage.getItem('adm_token')) startApp();
</script>
</body>
</html>
