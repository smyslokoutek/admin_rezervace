<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Smyslokoutek</title>

  <script>
    (function () {
      if (location.hostname.endsWith('.github.io')) {
        location.replace('https://admin.smyslokoutek.cz' + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <meta name="robots" content="noindex,nofollow">

  <style>
    :root{--ink:#111827;--muted:#6b7280;--card:#fff;--bg:#f9fafb;--brand:#111;--ok:#16a34a;--err:#dc2626}
    body{font-family:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1180px;margin:40px auto;padding:20px}
    .card{background:var(--card);padding:18px 20px;margin-bottom:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    h1{font-size:22px;margin:0 0 16px} h2{font-size:18px;margin:0 0 10px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;margin-top:4px;border:1px solid #e5e7eb;border-radius:8px;font-size:15px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer; touch-action:manipulation}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .error{color:var(--err);margin-top:8px}
    .ok{color:var(--ok);margin-top:8px}
    nav{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    nav button{background:#e5e7eb;color:#111} nav button.active{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f3f4f6}
    tr:hover{background:#fafafa}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .sel{background:#fef3c7 !important}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff}
    .log{margin:10px 0;padding:10px;border-radius:8px;background:#fff;border:1px dashed #e5e7eb;font:12px/1.5 ui-monospace,Menlo,monospace;max-height:160px;overflow:auto;white-space:pre-wrap}

    /* ==== sticky edit panel (a≈• nikdy ‚Äúneodjede do ≈ôiti‚Äù) ==== */
    .sticky{
      position:sticky;
      top:16px;
    }
    @media (max-width:980px){
      .sticky{ position:static; top:auto; }
    }

    /* ==== semafor / doporuƒçen√≠ ==== */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;white-space:nowrap}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .b-crit{background:#fee2e2;color:#991b1b}
    .b-crit .dot{background:#dc2626}
    .b-watch{background:#fef3c7;color:#92400e}
    .b-watch .dot{background:#f59e0b}
    .b-ok{background:#e5e7eb;color:#374151}
    .b-ok .dot{background:#6b7280}
    .b-sold{background:#111;color:#fff}
    .b-sold .dot{background:#fff}
    .mono{font:12px/1.4 ui-monospace,Menlo,monospace;color:#374151}

    /* ==== ‚ÄúCo ≈ôe≈°it‚Äù panel: max v√Ω≈°ka + scroll ==== */
    .subnav{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
    .subnav button{margin-top:0;background:#e5e7eb;color:#111;padding:8px 12px;border-radius:999px;font-weight:800}
    .subnav button.active{background:#111;color:#fff}
    .actionBox{
      border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;
      max-height:260px; overflow:auto;
    }
    .actionRow{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px;margin-bottom:10px;
      background:#fafafa;
    }
    .actionLeft{display:flex;flex-direction:column;gap:2px;min-width:0}
    .actionTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actionMeta{color:#6b7280;font-size:12px}
    .actionBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btnSmall{margin-top:0;padding:8px 10px;border-radius:10px;font-size:13px;font-weight:900;background:#e5e7eb;color:#111}
    .btnSmall.primary{background:#111;color:#fff}
    .summaryLine{display:flex;justify-content:flex-end;gap:10px;align-items:center;color:#6b7280;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin ‚Äì Smyslokoutek</h1>

  <div id="loginCard" class="card">
    <div id="stepEmail">
      <label>Zadejte e-mail</label>
      <input id="email" type="email" placeholder="nap≈ô. info@smyslokoutek.cz" />
      <button id="sendOtpBtn">Poslat k√≥d</button>
      <div id="msgEmail" class="error"></div>
    </div>
    <div id="stepOtp" style="display:none">
      <label>Zadejte k√≥d z e-mailu</label>
      <input id="otp" type="text" placeholder="6m√≠stn√Ω k√≥d" />
      <button id="verifyOtpBtn">P≈ôihl√°sit</button>
      <div id="msgOtp" class="error"></div>
    </div>
    <div id="debug" class="log" style="display:none"></div>
  </div>

  <div id="app" style="display:none">
    <nav>
      <button data-tab="events" class="active">Term√≠ny</button>
      <button data-tab="coupons">Kupony</button>
      <button data-tab="bookings">Rezervace</button>
      <button data-tab="archive">Archiv</button>
      <div class="right" style="margin-left:auto"><button id="logoutBtn">Odhl√°sit</button></div>
    </nav>

    <div id="tab-events">
      <div class="grid">
        <div class="card">
          <h2>Seznam term√≠n≈Ø</h2>

          <div class="subnav">
            <button id="view_actions" class="active">‚è±Ô∏è Co ≈ôe≈°it</button>
            <button id="view_table">üìã Pohled</button>
            <div class="right" style="margin-left:auto">
              <select id="windowSel" style="width:auto;min-width:170px;margin-top:0">
                <option value="30">Mƒõs√≠c (30 dn√≠)</option>
                <option value="14">14 dn√≠</option>
                <option value="7">7 dn√≠</option>
              </select>
            </div>
          </div>

          <div id="actionsWrap">
            <div class="actionBox" id="actionsBox">
              <div class="muted">Naƒç√≠t√°m √∫koly‚Ä¶</div>
            </div>
            <div class="summaryLine" id="actionsSummary"></div>
          </div>

          <div class="toolbar" style="margin-top:12px">
            <input id="f_from" type="date" />
            <input id="f_to" type="date" />
            <input id="f_q" placeholder="Hledat v ID / n√°zvu" style="flex:1" />
            <button id="ev_export">Export rezervac√≠</button>
            <button id="ev_archive">Archivovat</button>
          </div>
          <div class="muted">Kliknut√≠m vybere≈° term√≠n pro √∫pravu / export / archivaci.</div>

          <div id="tableWrap" style="display:block">
            <table id="eventsTable"><thead><tr>
              <th>ID</th><th>N√°zev</th><th>Start</th><th>Kap.</th><th>Obs.</th><th>Semafor</th><th>Doporuƒçen√≠</th><th>Cena</th><th>Sleva souroz.</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div class="card sticky">
          <h2>Nov√Ω / √∫prava term√≠nu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Events</span>.</div>
          <label>ID</label><input id="ev_id" />
          <label>N√°zev</label><input id="ev_name" />
          <div class="row">
            <div><label>Start</label><input id="ev_start" type="datetime-local" /></div>
            <div><label>D√©lka (min)</label><input id="ev_duration" type="number" value="90" /></div>
          </div>
          <div class="row">
            <div><label>Kapacita</label><input id="ev_capacity" type="number" value="12" /></div>
            <div><label>Cena (Kƒç)</label><input id="ev_price" type="number" value="200" /></div>
          </div>
          <label>Sleva pro sourozence</label><input id="ev_sibling" type="number" value="20" />
          <div class="right"><button id="ev_reset">Vymazat</button><button id="ev_save">Ulo≈æit</button></div>
          <div id="ev_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-coupons" style="display:none">
      <div class="grid">
        <div class="card">
          <h2>Seznam kupon≈Ø</h2>
          <div class="right"><button id="cp_delete">Smazat / deaktivovat</button></div>
          <div class="muted">Klikni na kupon pro √∫pravu (a pro smaz√°n√≠/deaktivaci).</div>
          <table id="couponsTable"><thead><tr>
            <th>K√≥d</th><th>Typ</th><th>Hodnota</th><th>Max pou≈æ.</th><th>Vyƒçerp√°no</th><th>Min qty</th><th>Aktivn√≠</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Nov√Ω / √∫prava kuponu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Coupons</span>.</div>
          <label>K√≥d</label><input id="cp_code" />
          <div class="row">
            <div><label>Typ</label>
              <select id="cp_type">
                <option value="amount">amount (Kƒç)</option>
                <option value="percent">percent (%)</option>
                <option value="free">free (poƒçet m√≠st)</option>
                <option value="bogo">bogo (1+1, qty=2)</option>
              </select>
            </div>
            <div><label>Hodnota</label><input id="cp_value" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Max. pou≈æit√≠</label><input id="cp_maxuses" type="number" /></div>
            <div><label>Min. qty</label><input id="cp_minqty" type="number" /></div>
          </div>
          <label>Ud√°losti (id, * = v≈°echny)</label><input id="cp_events" />
          <div class="row">
            <div><label>Stack se sourozenci?</label><select id="cp_stack"><option value="true">TRUE</option><option value="false">FALSE</option></select></div>
            <div><label>Max sleva (jen pro %)</label><input id="cp_cap" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Platnost od</label><input id="cp_from" type="date" /></div>
            <div><label>Platnost do</label><input id="cp_to" type="date" /></div>
          </div>
          <label>Aktivn√≠</label><select id="cp_active"><option value="1">1</option><option value="0">0</option></select>
          <label>Pozn√°mka</label><input id="cp_note" />
          <div class="right"><button id="cp_reset">Vymazat</button><button id="cp_save">Ulo≈æit</button></div>
          <div id="cp_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-bookings" style="display:none">
      <div class="card">
        <h2>Rezervace</h2>
        <div class="toolbar">
          <select id="b_ev" style="min-width:320px"><option value="">(v≈°echny ud√°losti)</option></select>
          <input id="b_from" type="date" />
          <input id="b_to" type="date" />
          <input id="b_q" placeholder="Hledat (jm√©no, e-mail, tel.)" style="flex:1" />
          <button id="b_export">Export aktu√°ln√≠ho v√Ωbƒõru</button>
        </div>
        <table id="bookingsTable"><thead><tr>
          <th>TS</th><th>Event</th><th>Jm√©no</th><th>Email</th><th>Tel</th><th>M√≠st</th><th>Platba</th><th>Celkem</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h2>Upravit rezervaci</h2>
        <div class="muted">Klikni v tabulce na ≈ô√°dek ‚Äì z√°znam se naƒçte sem.</div>
        <div class="row">
          <div><label>Jm√©no</label><input id="bk_name"/></div>
          <div><label>Qty</label><input id="bk_qty" type="number" min="0"/></div>
        </div>
        <div class="row">
          <div><label>Telefon</label><input id="bk_phone"/></div>
          <div><label>E-mail</label><input id="bk_email"/></div>
        </div>
        <label>Platba</label>
        <select id="bk_payment"><option value="cash">cash</option><option value="transfer">transfer</option></select>
        <div class="right"><button id="bk_save">Ulo≈æit zmƒõny</button></div>
        <div id="bk_msg" class="error"></div>
      </div>
    </div>

    <div id="tab-archive" style="display:none">
      <div class="card">
        <h2>Archiv term√≠n≈Ø</h2>
        <table id="archiveTable"><thead><tr>
          <th>ID</th><th>N√°zev</th><th>Start</th><th>Kapacita</th><th>Obsazeno</th><th>Cena</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== KONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzAJh9wVawvTfLUfsi7qqtkxyaT5Hpm69gyAlwNROW8N5S-MEIrOSW541caGaRQ5ysl_g/exec';
if(!API_URL || !API_URL.includes('/exec')){ alert('Chyb√≠ platn√° API_URL!'); }

/* ===== SEMAFOR LOGIKA (srozumiteln√© prahy) ===== */
const CRIT_DAYS = 7;         // do 7 dn≈Ø = krizov√© (pokud chyb√≠ m√≠sta)
const WATCH_DAYS = 14;       // do 14 dn≈Ø = pozor
const MIN_LEFT_ALERT = 3;    // alert m√° smysl, kdy≈æ chyb√≠ alespo≈à 3 m√≠sta

function badgeHtml(kind, text, title=''){
  const t = title ? ` title="${escapeHtml_(title)}"` : '';
  const cls = kind==='crit' ? 'b-crit' : kind==='watch' ? 'b-watch' : kind==='sold' ? 'b-sold' : 'b-ok';
  return `<span class="badge ${cls}"${t}><span class="dot"></span>${text}</span>`;
}

/* ===== HELPERY ===== */
const el = id => document.getElementById(id);
const errEmail = el('msgEmail'), errOtp = el('msgOtp'), dbg = el('debug');
function authQuery(){
  const t = localStorage.getItem('adm_token') || '';
  return 'Authorization=' + encodeURIComponent('Bearer ' + t);
}
function setSel(tr, tableSel){
  document.querySelectorAll(`${tableSel} tbody tr`).forEach(x=>x.classList.remove('sel'));
  tr.classList.add('sel');
}
function logDbg(obj){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }
  catch{ dbg.textContent = String(obj); }
}
function escapeHtml_(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function copyToClipboard_(text){
  const t = String(text||'');
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(t).catch(()=>{});
    return;
  }
  const ta = document.createElement('textarea');
  ta.value = t;
  document.body.appendChild(ta);
  ta.select();
  try{ document.execCommand('copy'); }catch{}
  ta.remove();
}

/* ===== FETCH WRAPPER (iOS hardening) ===== */
function withCacheBust(url){
  const u = new URL(url, location.href);
  u.searchParams.set('_', String(Date.now()));
  return u.toString();
}
async function apiFetch(url, opts={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), opts.timeoutMs || 20000);

  try{
    const r = await fetch(withCacheBust(url), {
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow',
      ...opts,
      headers: { 'Content-Type':'text/plain; charset=utf-8', ...(opts.headers||{}) },
      signal: controller.signal
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{ j = { ok:false, error:'Neplatn√° odpovƒõƒè serveru', raw: txt }; }
    return j;
  } finally {
    clearTimeout(t);
  }
}

/* ===== OTP ===== */
el('sendOtpBtn').onclick = async ()=>{
  const email = el('email').value.trim().toLowerCase();
  errEmail.textContent=''; logDbg('');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errEmail.textContent='Zadejte platn√Ω e-mail.'; return; }
  const b=el('sendOtpBtn'); b.disabled=true; b.textContent='Odes√≠l√°m‚Ä¶';
  try{
    const j = await apiFetch(API_URL+'?action=auth_request_otp', { method:'POST', body: JSON.stringify({email}) });
    logDbg(j);
    if(!j.ok){ errEmail.textContent=j.error||'Nepoda≈ôilo se odeslat k√≥d.'; return; }
    el('stepEmail').style.display='none';
    el('stepOtp').style.display='block';
    errOtp.textContent='K√≥d odesl√°n (plat√≠ 5 min).';
  }catch(e){
    errEmail.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }finally{
    setTimeout(()=>{ b.disabled=false; b.textContent='Poslat k√≥d'; }, 30000);
  }
};
el('verifyOtpBtn').onclick = async ()=>{
  const email=el('email').value.trim().toLowerCase();
  const code=el('otp').value.trim();
  errOtp.textContent=''; logDbg('');
  try{
    const j = await apiFetch(API_URL+'?action=auth_verify_otp', { method:'POST', body: JSON.stringify({email,code}) });
    logDbg(j);
    if(!j.ok){ errOtp.textContent=j.error||'Chybn√Ω k√≥d.'; return; }
    localStorage.setItem('adm_token', j.token);
    startApp();
  }catch(e){
    errOtp.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }
};

/* ===== NAV ===== */
document.querySelectorAll('nav button[data-tab]').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('[id^=tab-]').forEach(x=>x.style.display='none');
    el('tab-'+b.dataset.tab).style.display='block';
  };
});
el('logoutBtn').onclick = ()=>{ localStorage.removeItem('adm_token'); location.reload(); };

/* ===== VIEW TOGGLE (Co ≈ôe≈°it / Pohled) ===== */
el('view_actions').onclick = ()=>{
  el('view_actions').classList.add('active');
  el('view_table').classList.remove('active');
  el('actionsWrap').style.display='block';
  el('tableWrap').style.display='block';
};
el('view_table').onclick = ()=>{
  el('view_table').classList.add('active');
  el('view_actions').classList.remove('active');
  el('actionsWrap').style.display='none';
  el('tableWrap').style.display='block';
};

/* ===== STATE ===== */
let SELECTED_EVENT_ID='';
let SELECTED_COUPON_CODE='';
let BOOKING_KEY=null;

let LAST_EVENTS = [];

/* ===== EVENTS ===== */
['f_from','f_to','f_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadEvents());
});

el('windowSel').addEventListener('change', ()=>{
  buildActionPanel(LAST_EVENTS);
});

el('ev_export').onclick = ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(SELECTED_EVENT_ID)+'&'+authQuery();
};
el('ev_archive').onclick = async ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  if(!confirm('Archivovat vybran√Ω term√≠n?')) return;

  const j = await apiFetch(API_URL+'?action=admin_event_archive&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({id:SELECTED_EVENT_ID})
  });
  if(!j.ok){ alert(j.error||'Archivace selhala'); return; }
  SELECTED_EVENT_ID='';
  await loadEvents();
  alert('Term√≠n p≈ôesunut do archivu.');
};

function daysTo_(d){
  const now = new Date();
  const ms = 24*60*60*1000;
  return Math.ceil((d - now)/ms);
}

function classifyEvent_(ev){
  const cap = Number(ev.capacity||0);
  const taken = Number(ev.taken||0);
  const left = cap - taken;
  const start = new Date(ev.start);
  const d = daysTo_(start);

  if(left <= 0){
    return { kind:'sold', label:'VYPROD√ÅNO', rec:'‚Äî', d, left, cap, start };
  }

  // okno dle selectu v UI
  const windowDays = Number(el('windowSel').value||30);
  if(d > windowDays){
    return { kind:'ok', label:'OK', rec:'‚Äî', d, left, cap, start, hidden:true };
  }

  // semafor: srozumitelnƒõ podle ƒçasu a kolik m√≠st chyb√≠
  if(d <= CRIT_DAYS && left >= MIN_LEFT_ALERT){
    return {
      kind:'crit',
      label:'KRIZOV√â',
      rec:`D√°t dnes post + story (p≈ôipomenout).`,
      d, left, cap, start
    };
  }
  if(d <= WATCH_DAYS && left >= MIN_LEFT_ALERT){
    return {
      kind:'watch',
      label:'POZOR',
      rec:`Podpo≈ôit v t√Ωdnu (post / stories / p≈ôipomenut√≠ ve skupin√°ch).`,
      d, left, cap, start
    };
  }

  return { kind:'ok', label:'OK', rec:`Jen hl√≠dat.`, d, left, cap, start };
}

function formatStartHuman_(ev){
  try{
    const d = new Date(ev.start);
    return d.toLocaleString('cs-CZ', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }).replace(',', '');
  }catch{
    return String(ev.start||'');
  }
}

function buildIGText_(ev, cls){
  const when = formatStartHuman_(ev);
  const missing = Math.max(0, Number(ev.capacity||0) - Number(ev.taken||0));
  return `${ev.name}\nüìÖ ${when}\nüëâ Voln√° m√≠sta: ${missing}\nRezervace: smyslokoutek.cz`;
}

function buildActionPanel(events){
  const box = el('actionsBox');
  const sum = el('actionsSummary');
  const windowDays = Number(el('windowSel').value||30);

  const rows = [];
  let nCrit=0, nWatch=0, nOk=0;

  events.forEach(ev=>{
    const c = classifyEvent_(ev);
    if(c.hidden) return;

    if(c.kind==='crit') nCrit++;
    else if(c.kind==='watch') nWatch++;
    else if(c.kind==='ok') nOk++;

    if(c.kind==='ok') return; // ‚ÄúCo ≈ôe≈°it‚Äù ukazuje jen akƒçn√≠ vƒõci

    const label = badgeHtml(c.kind, c.label, `Do term√≠nu ${c.d} dn√≠ ‚Ä¢ chyb√≠ ${c.left} m√≠st z ${c.cap}`);
    const line1 = `Do term√≠nu ${c.d} dn√≠, chyb√≠ ${c.left} m√≠st.`;
    const line2 = `Doporuƒçen√≠: ${c.rec}`;
    const meta = `${ev.name} ‚Ä¢ ${formatStartHuman_(ev)} ‚Ä¢ chyb√≠ ${c.left} m√≠st`;

    rows.push(`
      <div class="actionRow">
        <div class="actionLeft">
          <div class="actionTitle">${label} <span class="mono">${escapeHtml_(line1)}</span></div>
          <div class="actionMeta">${escapeHtml_(line2)}</div>
          <div class="actionMeta">${escapeHtml_(meta)}</div>
        </div>
        <div class="actionBtns">
          <button class="btnSmall" data-copy="${escapeHtml_(buildIGText_(ev, c))}">Zkop√≠rovat text (IG/FB)</button>
          <button class="btnSmall primary" data-pick="${escapeHtml_(ev.id)}">Vybrat term√≠n</button>
        </div>
      </div>
    `);
  });

  if(!rows.length){
    box.innerHTML = `<div class="muted">V r√°mci ${windowDays} dn≈Ø nen√≠ nic akutn√≠ho üéâ</div>`;
  }else{
    box.innerHTML = rows.join('');
  }

  sum.textContent = `V√Ωhled ${windowDays} dn√≠: ${events.filter(ev=>!classifyEvent_(ev).hidden).length} term√≠n≈Ø ‚Ä¢ √∫koly: ${nCrit}√ó kritick√©, ${nWatch}√ó pozor`;

  // bind tlaƒç√≠tek
  box.querySelectorAll('button[data-copy]').forEach(btn=>{
    btn.onclick = ()=>{
      const txt = btn.getAttribute('data-copy') || '';
      copyToClipboard_(txt);
      btn.textContent = 'Zkop√≠rov√°no ‚úÖ';
      setTimeout(()=>btn.textContent='Zkop√≠rovat text (IG/FB)', 1400);
    };
  });
  box.querySelectorAll('button[data-pick]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-pick') || '';
      const tr = document.querySelector(`#eventsTable tbody tr[data-evid="${CSS.escape(id)}"]`);
      if(tr) tr.scrollIntoView({ behavior:'smooth', block:'center' });
      // ‚Äúklik‚Äù na ≈ô√°dek = naƒçti do formul√°≈ôe
      if(tr) tr.click();
    };
  });
}

async function loadEvents(){
  const box=el('eventsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="9">Naƒç√≠t√°m‚Ä¶</td></tr>';

  try{
    const p=new URLSearchParams({
      action:'admin_events_list',
      from: el('f_from').value||'',
      to: el('f_to').value||'',
      q: el('f_q').value||''
    });
    const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');
    LAST_EVENTS = j.items||[];
    renderEvents(LAST_EVENTS);
    buildActionPanel(LAST_EVENTS);
  }catch(e){
    box.innerHTML=`<tr><td colspan="9" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}

function renderEvents(items){
  const box=el('eventsTable').querySelector('tbody');
  SELECTED_EVENT_ID='';
  if(!items.length){ box.innerHTML='<tr><td colspan="9">≈Ω√°dn√© term√≠ny.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(ev=>{
    const tr=document.createElement('tr');
    tr.setAttribute('data-evid', ev.id);

    const c = classifyEvent_(ev);
    const cap = Number(ev.capacity||0);
    const taken = Number(ev.taken||0);
    const left = cap - taken;

    const sem = badgeHtml(c.kind, c.label, `Do term√≠nu ${c.d} dn√≠ ‚Ä¢ chyb√≠ ${left} m√≠st z ${cap}`);
    const rec = c.kind==='sold' ? '‚Äî'
              : c.kind==='crit' ? `Do term√≠nu ${c.d} dn√≠, chyb√≠ ${left} m√≠st. ${c.rec}`
              : c.kind==='watch' ? `Do term√≠nu ${c.d} dn√≠, chyb√≠ ${left} m√≠st. ${c.rec}`
              : `Do term√≠nu ${c.d} dn√≠. ${c.rec}`;

    tr.innerHTML=
      `<td>${escapeHtml_(ev.id)}</td>
       <td>${escapeHtml_(ev.name)}</td>
       <td>${escapeHtml_(formatStartHuman_(ev))}</td>
       <td>${cap}</td>
       <td>${taken}</td>
       <td>${sem}</td>
       <td class="muted">${escapeHtml_(rec)}</td>
       <td>${Number(ev.price||0)}</td>
       <td>${Number(ev.sibling_discount||0)}</td>`;

    const onPick = ()=>{
      setSel(tr,'#eventsTable');
      SELECTED_EVENT_ID=ev.id;
      fillEventForm(ev);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true}); // iOS fallback
    box.appendChild(tr);
  });
}

function fillEventForm(ev){
  el('ev_id').value=ev.id||'';
  el('ev_name').value=ev.name||'';
  try{
    const d=new Date(ev.start);
    const pad=n=>String(n).padStart(2,'0');
    el('ev_start').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{}
  el('ev_duration').value=ev.duration||90;
  el('ev_capacity').value=ev.capacity||0;
  el('ev_price').value=ev.price||0;
  el('ev_sibling').value=ev.sibling_discount||0;
}

el('ev_save').onclick = async ()=>{
  const msg=el('ev_msg');
  msg.className='error';
  msg.textContent='';

  if(!el('ev_name').value.trim()){ msg.textContent='Vypl≈à n√°zev.'; return; }
  if(!el('ev_start').value){ msg.textContent='Vypl≈à datum a ƒças.'; return; }

  const payload={
    id: el('ev_id').value.trim(),
    name: el('ev_name').value.trim(),
    start: el('ev_start').value,
    duration: Number(el('ev_duration').value||90),
    capacity: Number(el('ev_capacity').value||0),
    price: Number(el('ev_price').value||0),
    sibling_discount: Number(el('ev_sibling').value||0)
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_event_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadEvents();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

el('ev_reset').onclick = ()=>{
  SELECTED_EVENT_ID='';
  document.querySelectorAll('#eventsTable tbody tr').forEach(x=>x.classList.remove('sel'));
  el('ev_id').value='';
  el('ev_name').value='';
  el('ev_start').value='';
  el('ev_duration').value=90;
  el('ev_capacity').value=12;
  el('ev_price').value=200;
  el('ev_sibling').value=20;
  el('ev_msg').textContent='';
};

/* ===== COUPONS ===== */
el('cp_delete').onclick = async ()=>{
  if(!SELECTED_COUPON_CODE){ alert('Vyber kupon.'); return; }
  const hard=confirm('Smazat trvale? (OK = hard delete, Zru≈°it = deaktivovat)');
  const j = await apiFetch(API_URL+'?action=admin_coupon_delete&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({code:SELECTED_COUPON_CODE,hard})
  });
  if(!j.ok){ alert(j.error||'Maz√°n√≠ selhalo'); return; }
  SELECTED_COUPON_CODE='';
  await loadCoupons();
  alert(hard?'Kupon smaz√°n.':'Kupon deaktivov√°n.');
};
async function loadCoupons(){
  const box=el('couponsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="7">Naƒç√≠t√°m‚Ä¶</td></tr>';
  try{
    const j = await apiFetch(API_URL+'?action=admin_coupons_list&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');
    renderCoupons(j.items||[]);
  }catch(e){
    box.innerHTML=`<tr><td colspan="7" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}
function renderCoupons(items){
  const box=el('couponsTable').querySelector('tbody');
  SELECTED_COUPON_CODE='';
  if(!items.length){ box.innerHTML='<tr><td colspan="7">≈Ω√°dn√© kupony.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.code}</td><td>${c.type}</td><td>${c.value}</td><td>${c.max_uses}</td><td>${c.used}</td><td>${c.min_qty}</td><td>${c.active}</td>`;

    const onPick = ()=>{
      setSel(tr,'#couponsTable');
      SELECTED_COUPON_CODE=c.code;
      fillCouponForm(c);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});
    box.appendChild(tr);
  });
}
function fillCouponForm(c){
  el('cp_code').value=c.code||'';
  el('cp_type').value=c.type||'amount';
  el('cp_value').value=c.value||0;
  el('cp_maxuses').value=c.max_uses||0;
  el('cp_minqty').value=c.min_qty||1;
  el('cp_events').value=c.events||'*';
  el('cp_stack').value=c.stack_with_siblings?'true':'false';
  el('cp_cap').value=c.max_discount||'';
  el('cp_from').value=(c.valid_from||'').split('T')[0]||'';
  el('cp_to').value=(c.valid_to||'').split('T')[0]||'';
  el('cp_active').value=(c.active?1:0);
  el('cp_note').value=c.note||'';
}
el('cp_save').onclick = async ()=>{
  const msg=el('cp_msg');
  msg.className='error';
  msg.textContent='';
  if(!el('cp_code').value.trim()){ msg.textContent='Vypl≈à k√≥d.'; return; }

  const payload={
    code: el('cp_code').value.trim().toUpperCase(),
    type: el('cp_type').value,
    value: Number(el('cp_value').value||0),
    max_uses: Number(el('cp_maxuses').value||0),
    min_qty: Number(el('cp_minqty').value||1),
    events: el('cp_events').value.trim()||'*',
    stack_with_siblings:(el('cp_stack').value==='true'),
    max_discount: el('cp_cap').value?Number(el('cp_cap').value):null,
    valid_from: el('cp_from').value||null,
    valid_to: el('cp_to').value||null,
    active: Number(el('cp_active').value||1),
    note: el('cp_note').value||''
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_coupon_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadCoupons();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};
el('cp_reset').onclick = ()=>{
  SELECTED_COUPON_CODE='';
  document.querySelectorAll('#couponsTable tbody tr').forEach(x=>x.classList.remove('sel'));
  el('cp_code').value='';
  el('cp_type').value='amount';
  el('cp_value').value='';
  el('cp_maxuses').value='';
  el('cp_minqty').value='';
  el('cp_events').value='*';
  el('cp_stack').value='true';
  el('cp_cap').value='';
  el('cp_from').value='';
  el('cp_to').value='';
  el('cp_active').value='1';
  el('cp_note').value='';
  el('cp_msg').textContent='';
};

/* ===== BOOKINGS ===== */
el('b_export').onclick = ()=>{
  const v=el('b_ev').value;
  if(!v){ alert('Vyber ud√°lost v rozbalovaƒçce.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(v)+'&'+authQuery();
};
['b_ev','b_from','b_to','b_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadBookings());
});

async function loadEventDropdown(){
  const j = await apiFetch(API_URL+'?action=admin_events_dropdown', { method:'GET' });
  if(j.ok){
    const sel=el('b_ev');
    sel.innerHTML='<option value="">(v≈°echny ud√°losti)</option>';
    (j.items||[]).forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id;
      o.textContent=it.label;
      sel.appendChild(o);
    });
  }
}
async function loadBookings(){
  const tb=el('bookingsTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="8">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const p=new URLSearchParams({
    action:'admin_bookings_list',
    eventId: el('b_ev').value||'',
    from: el('b_from').value||'',
    to: el('b_to').value||'',
    q: el('b_q').value||'',
    page:'1',
    pageSize:'200'
  });

  const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="8" style="color:#dc2626">'+(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="8">≈Ω√°dn√© rezervace.</td></tr>';
    return;
  }

  (j.items||[]).forEach(bk=>{
    const tr=document.createElement('tr');

    let tsIso = '';
    try{
      const d = new Date(bk.ts);
      tsIso = !isNaN(d.getTime()) ? d.toISOString() : String(bk.ts||'');
    }catch{ tsIso = String(bk.ts||''); }

    tr.innerHTML=`<td>${new Date(bk.ts).toLocaleString('cs-CZ')}</td><td>${bk.eventId}</td><td>${bk.name||''}</td>
      <td>${bk.email||''}</td><td>${bk.phone||''}</td><td>${bk.qty}</td><td>${bk.payment||''}</td><td>${bk.total||0}</td>`;

    const onPick = ()=>{
      setSel(tr,'#bookingsTable');
      BOOKING_KEY = { ts: tsIso, eventId: bk.eventId };

      el('bk_name').value=bk.name||'';
      el('bk_qty').value=bk.qty||0;
      el('bk_phone').value=bk.phone||'';
      el('bk_email').value=bk.email||'';
      el('bk_payment').value=bk.payment||'cash';
    };

    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});
    tb.appendChild(tr);
  });
}
el('bk_save').onclick = async ()=>{
  const msg=el('bk_msg');
  msg.className='error';
  msg.textContent='';
  if(!BOOKING_KEY){ msg.textContent='Nen√≠ vybran√Ω z√°znam.'; return; }

  const payload={
    ts: BOOKING_KEY.ts,
    eventId: BOOKING_KEY.eventId,
    name: el('bk_name').value.trim(),
    phone: el('bk_phone').value.trim(),
    email: el('bk_email').value.trim(),
    qty: Number(el('bk_qty').value||0),
    paymentMethod: el('bk_payment').value
  };

  const j = await apiFetch(API_URL+'?action=admin_booking_update&'+authQuery(), {
    method:'POST',
    body: JSON.stringify(payload)
  });

  if(!j.ok){
    msg.className='error';
    msg.textContent=j.error||'Ulo≈æen√≠ selhalo';
    return;
  }

  msg.className='ok';
  msg.textContent='Ulo≈æeno.';
  await loadBookings();
};

/* ===== ARCHIVE ===== */
async function loadArchive(){
  const tb=el('archiveTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="6">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const j = await apiFetch(API_URL+'?action=admin_events_archive&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="6" style="color:#dc2626">'+(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="6">Archiv je pr√°zdn√Ω.</td></tr>';
    return;
  }

  (j.items||[]).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ev.id}</td><td>${ev.name}</td><td>${ev.start}</td><td>${ev.capacity}</td><td>${ev.taken}</td><td>${ev.price}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== START ===== */
async function startApp(){
  try{
    const j = await apiFetch(API_URL+'?action=session&'+authQuery(), { method:'GET' });
    if(!j.ok){ localStorage.removeItem('adm_token'); location.reload(); return; }
    el('loginCard').style.display='none';
    el('app').style.display='block';
    await Promise.all([loadEventDropdown(), loadEvents(), loadCoupons(), loadBookings(), loadArchive()]);
  }catch(e){
    logDbg(String(e));
    localStorage.removeItem('adm_token');
    location.reload();
  }
}
if(localStorage.getItem('adm_token')) startApp();
</script>
</body>
</html>
