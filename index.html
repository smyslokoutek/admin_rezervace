<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin ‚Äì Smyslokoutek</title>

  <script>
    (function () {
      if (location.hostname.endsWith('.github.io')) {
        location.replace('https://admin.smyslokoutek.cz' + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <meta name="robots" content="noindex,nofollow">

  <style>
    :root{--ink:#111827;--muted:#6b7280;--card:#fff;--bg:#f9fafb;--brand:#111;--ok:#16a34a;--err:#dc2626}
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    body{font-family:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1180px;margin:40px auto;padding:20px}
    .card{background:var(--card);padding:18px 20px;margin-bottom:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    h1{font-size:22px;margin:0 0 16px} h2{font-size:18px;margin:0 0 10px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;margin-top:4px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;background:#fff} /* iOS: 16px => nezoomuje */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer; touch-action:manipulation}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .error{color:var(--err);margin-top:8px}
    .ok{color:var(--ok);margin-top:8px}
    nav{display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    nav button{background:#e5e7eb;color:#111;margin-top:0}
    nav button.active{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
    th{background:#f3f4f6}
    tr:hover{background:#fafafa}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .sel{background:#fef3c7 !important}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff}
    .log{margin:10px 0;padding:10px;border-radius:8px;background:#fff;border:1px dashed #e5e7eb;font:12px/1.5 ui-monospace,Menlo,monospace;max-height:160px;overflow:auto;white-space:pre-wrap}
    .tableWrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px}
    .tableWrap table{min-width:860px}

    /* ===== ‚ÄúCO ≈òE≈†IT‚Äù ===== */
    .seg{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .seg button{background:#e5e7eb;color:#111;margin-top:0}
    .seg button.active{background:#111;color:#fff}
    .tasks{margin-top:12px;display:grid;gap:10px}
    .task{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:12px;display:flex;gap:12px;align-items:flex-start;justify-content:space-between}
    .task .left{min-width:0}
    .task .title{font-weight:900}
    .task .meta{margin-top:2px;color:#6b7280;font-size:12px}
    .task .actions{display:flex;gap:8px;align-items:center;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end}
    .task .actions button{margin-top:0;background:#111}
    .task .actions button.alt{background:#e5e7eb;color:#111;font-weight:800}
    .task .rec{margin-top:6px;color:#374151;font-size:13px}
    .summary{margin-top:10px;color:#6b7280;font-size:12px;text-align:right}

    /* ===== SEMAFOR ===== */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px}
    .b-crit{background:#fee2e2;color:#991b1b}
    .b-warn{background:#fef3c7;color:#92400e}
    .b-ok{background:#e0e7ff;color:#1e3a8a}
    .b-sold{background:#111;color:#fff}
    .mono{font:12px/1.4 ui-monospace,Menlo,monospace;color:#374151}

    @media (max-width:520px){
      .wrap{margin:16px auto;padding:12px}
      h1{font-size:20px}
      .card{padding:14px 14px}
      .task{flex-direction:column;align-items:stretch}
      .task .actions{justify-content:flex-start}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin ‚Äì Smyslokoutek</h1>

  <div id="loginCard" class="card">
    <div id="stepEmail">
      <label>Zadejte e-mail</label>
      <input id="email" type="email" placeholder="nap≈ô. info@smyslokoutek.cz" />
      <button id="sendOtpBtn">Poslat k√≥d</button>
      <div id="msgEmail" class="error"></div>
    </div>
    <div id="stepOtp" style="display:none">
      <label>Zadejte k√≥d z e-mailu</label>
      <input id="otp" type="text" placeholder="6m√≠stn√Ω k√≥d" />
      <button id="verifyOtpBtn">P≈ôihl√°sit</button>
      <div id="msgOtp" class="error"></div>
    </div>
    <div id="debug" class="log" style="display:none"></div>
  </div>

  <div id="app" style="display:none">
    <nav>
      <button data-tab="events" class="active">Term√≠ny</button>
      <button data-tab="coupons">Kupony</button>
      <button data-tab="bookings">Rezervace</button>
      <button data-tab="archive">Archiv</button>
      <div class="right" style="margin-left:auto"><button id="logoutBtn">Odhl√°sit</button></div>
    </nav>

    <div id="tab-events">
      <div class="grid">
        <div class="card">
          <h2>Seznam term√≠n≈Ø</h2>

          <div class="seg" style="margin-top:6px">
            <button id="view_tasks" class="active">üß≠ Co ≈ôe≈°it</button>
            <button id="view_table">üßæ Pohled</button>
            <div style="margin-left:auto;min-width:180px">
              <select id="windowSel">
                <option value="7">T√Ωden (7 dn√≠)</option>
                <option value="14">2 t√Ωdny (14 dn√≠)</option>
                <option value="30" selected>Mƒõs√≠c (30 dn√≠)</option>
              </select>
            </div>
          </div>

          <div id="tasksBox" class="tasks"></div>
          <div id="tasksSummary" class="summary"></div>

          <div id="tableBox" style="display:none">
            <div class="toolbar">
              <input id="f_from" type="date" />
              <input id="f_to" type="date" />
              <input id="f_q" placeholder="Hledat v ID / n√°zvu" style="flex:1" />
              <button id="ev_export">Export rezervac√≠</button>
              <button id="ev_archive">Archivovat</button>
            </div>
            <div class="muted">Kliknut√≠m vybere≈° term√≠n pro √∫pravu / export / archivaci.</div>
            <div class="tableWrap">
              <table id="eventsTable"><thead><tr>
                <th>ID</th><th>N√°zev</th><th>Start</th><th>Kap.</th><th>Obs.</th><th>Semafor</th><th>Doporuƒçen√≠</th><th>Cena</th><th>Sleva souroz.</th>
              </tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>

        <div class="card" id="editCard">
          <h2>Nov√Ω / √∫prava term√≠nu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Events</span>.</div>
          <label>ID</label><input id="ev_id" />
          <label>N√°zev</label><input id="ev_name" />
          <div class="row">
            <div><label>Start</label><input id="ev_start" type="datetime-local" /></div>
            <div><label>D√©lka (min)</label><input id="ev_duration" type="number" value="90" /></div>
          </div>
          <div class="row">
            <div><label>Kapacita</label><input id="ev_capacity" type="number" value="12" /></div>
            <div><label>Cena (Kƒç)</label><input id="ev_price" type="number" value="200" /></div>
          </div>
          <label>Sleva pro sourozence</label><input id="ev_sibling" type="number" value="20" />
          <div class="right"><button id="ev_reset" style="background:#e5e7eb;color:#111;font-weight:900">Vymazat</button><button id="ev_save">Ulo≈æit</button></div>
          <div id="ev_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-coupons" style="display:none">
      <div class="grid">
        <div class="card">
          <h2>Seznam kupon≈Ø</h2>
          <div class="right"><button id="cp_delete">Smazat / deaktivovat</button></div>
          <div class="muted">Klikni na kupon pro √∫pravu (a pro smaz√°n√≠/deaktivaci).</div>
          <div class="tableWrap">
            <table id="couponsTable"><thead><tr>
              <th>K√≥d</th><th>Typ</th><th>Hodnota</th><th>Max pou≈æ.</th><th>Vyƒçerp√°no</th><th>Min qty</th><th>Aktivn√≠</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h2>Nov√Ω / √∫prava kuponu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Coupons</span>.</div>
          <label>K√≥d</label><input id="cp_code" />
          <div class="row">
            <div><label>Typ</label>
              <select id="cp_type">
                <option value="amount">amount (Kƒç)</option>
                <option value="percent">percent (%)</option>
                <option value="free">free (poƒçet m√≠st)</option>
                <option value="bogo">bogo (1+1, qty=2)</option>
              </select>
            </div>
            <div><label>Hodnota</label><input id="cp_value" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Max. pou≈æit√≠</label><input id="cp_maxuses" type="number" /></div>
            <div><label>Min. qty</label><input id="cp_minqty" type="number" /></div>
          </div>
          <label>Ud√°losti (id, * = v≈°echny)</label><input id="cp_events" />
          <div class="row">
            <div><label>Stack se sourozenci?</label><select id="cp_stack"><option value="true">TRUE</option><option value="false">FALSE</option></select></div>
            <div><label>Max sleva (jen pro %)</label><input id="cp_cap" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Platnost od</label><input id="cp_from" type="date" /></div>
            <div><label>Platnost do</label><input id="cp_to" type="date" /></div>
          </div>
          <label>Aktivn√≠</label><select id="cp_active"><option value="1">1</option><option value="0">0</option></select>
          <label>Pozn√°mka</label><input id="cp_note" />
          <div class="right"><button id="cp_reset" style="background:#e5e7eb;color:#111;font-weight:900">Vymazat</button><button id="cp_save">Ulo≈æit</button></div>
          <div id="cp_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-bookings" style="display:none">
      <div class="card">
        <h2>Rezervace</h2>
        <div class="toolbar">
          <select id="b_ev" style="min-width:320px"><option value="">(v≈°echny ud√°losti)</option></select>
          <input id="b_from" type="date" />
          <input id="b_to" type="date" />
          <input id="b_q" placeholder="Hledat (jm√©no, e-mail, tel.)" style="flex:1" />
          <button id="b_export">Export aktu√°ln√≠ho v√Ωbƒõru</button>
        </div>
        <div class="tableWrap">
          <table id="bookingsTable"><thead><tr>
            <th>TS</th><th>Event</th><th>Jm√©no</th><th>Email</th><th>Tel</th><th>M√≠st</th><th>Platba</th><th>Celkem</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h2>Upravit rezervaci</h2>
        <div class="muted">Klikni v tabulce na ≈ô√°dek ‚Äì z√°znam se naƒçte sem.</div>
        <div class="row">
          <div><label>Jm√©no</label><input id="bk_name"/></div>
          <div><label>Qty</label><input id="bk_qty" type="number" min="0"/></div>
        </div>
        <div class="row">
          <div><label>Telefon</label><input id="bk_phone"/></div>
          <div><label>E-mail</label><input id="bk_email"/></div>
        </div>
        <label>Platba</label>
        <select id="bk_payment"><option value="cash">cash</option><option value="transfer">transfer</option></select>
        <div class="right"><button id="bk_save">Ulo≈æit zmƒõny</button></div>
        <div id="bk_msg" class="error"></div>
      </div>
    </div>

    <div id="tab-archive" style="display:none">
      <div class="card">
        <h2>Archiv term√≠n≈Ø</h2>
        <div class="tableWrap">
          <table id="archiveTable"><thead><tr>
            <th>ID</th><th>N√°zev</th><th>Start</th><th>Kapacita</th><th>Obsazeno</th><th>Cena</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== KONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzAJh9wVawvTfLUfsi7qqtkxyaT5Hpm69gyAlwNROW8N5S-MEIrOSW541caGaRQ5ysl_g/exec';
if(!API_URL || !API_URL.includes('/exec')){ alert('Chyb√≠ platn√° API_URL!'); }

/* ===== HELPERY ===== */
const el = id => document.getElementById(id);
const errEmail = el('msgEmail'), errOtp = el('msgOtp'), dbg = el('debug');

function authQuery(){
  const t = localStorage.getItem('adm_token') || '';
  return 'Authorization=' + encodeURIComponent('Bearer ' + t);
}
function setSel(tr, tableSel){
  document.querySelectorAll(`${tableSel} tbody tr`).forEach(x=>x.classList.remove('sel'));
  tr.classList.add('sel');
}
function logDbg(obj){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }
  catch{ dbg.textContent = String(obj); }
}
function escapeHtml_(s){
  return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function daysDiff_(a, b){
  const ms = 24*60*60*1000;
  return Math.round((b - a)/ms);
}
function withCacheBust(url){
  const u = new URL(url, location.href);
  u.searchParams.set('_', String(Date.now()));
  return u.toString();
}
async function apiFetch(url, opts={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), opts.timeoutMs || 20000);
  try{
    const r = await fetch(withCacheBust(url), {
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow',
      ...opts,
      headers: { 'Content-Type':'text/plain; charset=utf-8', ...(opts.headers||{}) },
      signal: controller.signal
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{ j = { ok:false, error:'Neplatn√° odpovƒõƒè serveru', raw: txt }; }
    return j;
  } finally {
    clearTimeout(t);
  }
}

/* ===== OTP ===== */
el('sendOtpBtn').onclick = async ()=>{
  const email = el('email').value.trim().toLowerCase();
  errEmail.textContent=''; logDbg('');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errEmail.textContent='Zadejte platn√Ω e-mail.'; return; }
  const b=el('sendOtpBtn'); b.disabled=true; b.textContent='Odes√≠l√°m‚Ä¶';
  try{
    const j = await apiFetch(API_URL+'?action=auth_request_otp', { method:'POST', body: JSON.stringify({email}) });
    logDbg(j);
    if(!j.ok){ errEmail.textContent=j.error||'Nepoda≈ôilo se odeslat k√≥d.'; return; }
    el('stepEmail').style.display='none';
    el('stepOtp').style.display='block';
    errOtp.textContent='K√≥d odesl√°n (plat√≠ 5 min).';
  }catch(e){
    errEmail.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }finally{
    setTimeout(()=>{ b.disabled=false; b.textContent='Poslat k√≥d'; }, 30000);
  }
};
el('verifyOtpBtn').onclick = async ()=>{
  const email=el('email').value.trim().toLowerCase();
  const code=el('otp').value.trim();
  errOtp.textContent=''; logDbg('');
  try{
    const j = await apiFetch(API_URL+'?action=auth_verify_otp', { method:'POST', body: JSON.stringify({email,code}) });
    logDbg(j);
    if(!j.ok){ errOtp.textContent=j.error||'Chybn√Ω k√≥d.'; return; }
    localStorage.setItem('adm_token', j.token);
    startApp();
  }catch(e){
    errOtp.textContent='Chyba s√≠tƒõ ‚Äì zkuste znovu.';
    logDbg(String(e));
  }
};

/* ===== NAV ===== */
document.querySelectorAll('nav button[data-tab]').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('[id^=tab-]').forEach(x=>x.style.display='none');
    el('tab-'+b.dataset.tab).style.display='block';
    // na mobilu: v≈ædy korektn√≠ rozlo≈æen√≠ po p≈ôepnut√≠ (iOS nƒõkdy p≈ôepoƒç√≠t√° viewport a≈æ po reflow)
    requestAnimationFrame(()=>window.scrollTo({top:0,left:0,behavior:'auto'}));
  };
});
el('logoutBtn').onclick = ()=>{ localStorage.removeItem('adm_token'); location.reload(); };

/* ===== STATE ===== */
let SELECTED_EVENT_ID='';
let SELECTED_COUPON_CODE='';
let BOOKING_KEY=null;
let EVENTS_CACHE=[];

/* ===== ‚ÄúCO ≈òE≈†IT‚Äù logika (jen z Events dat) ===== */
function semaforFor_(ev){
  const cap = Number(ev.capacity||0);
  const taken = Number(ev.taken||0);
  const left = cap - taken;

  const start = new Date(ev.start);
  const now = new Date();
  const daysToStart = daysDiff_(now, start);

  if(left <= 0){
    return {
      key:'sold',
      badgeHtml:`<span class="badge b-sold"><span class="dot" style="background:#fff"></span>VYPROD√ÅNO</span>`,
      rec:'‚Äî',
      line:`Vyprod√°no.`
    };
  }

  const half = Math.ceil(cap * 0.5);
  const missing = left;

  // prahy (prakticky pro 8‚Äì12 kapacitu)
  if(daysToStart <= 7 && missing >= half){
    return {
      key:'crit',
      badgeHtml:`<span class="badge b-crit"><span class="dot" style="background:#dc2626"></span>KRIZOV√â</span>`,
      rec:'D√°t dnes post + story (p≈ôipomenout).',
      line:`Do term√≠nu ${Math.max(daysToStart,0)} dn√≠, chyb√≠ ${missing} m√≠st.`
    };
  }

  if(daysToStart <= 14 && missing >= half){
    return {
      key:'warn',
      badgeHtml:`<span class="badge b-warn"><span class="dot" style="background:#f59e0b"></span>POZOR</span>`,
      rec:'Podpo≈ôit v t√Ωdnu (post / stories / p≈ôipomenut√≠ ve skupin√°ch).',
      line:`Do term√≠nu ${Math.max(daysToStart,0)} dn√≠, chyb√≠ ${missing} m√≠st.`
    };
  }

  return {
    key:'ok',
    badgeHtml:`<span class="badge b-ok"><span class="dot" style="background:#2563eb"></span>OK</span>`,
    rec:'‚Äî',
    line:`Do term√≠nu ${Math.max(daysToStart,0)} dn√≠, volno ${missing} m√≠st.`
  };
}

function formatStartShort_(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString('cs-CZ', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }).replace(',', '');
  }catch{ return String(iso||''); }
}

async function copyText_(txt){
  try{
    await navigator.clipboard.writeText(txt);
    return true;
  }catch{
    // fallback
    const ta=document.createElement('textarea');
    ta.value=txt;
    ta.style.position='fixed'; ta.style.left='-9999px';
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    try{ document.execCommand('copy'); }catch{}
    document.body.removeChild(ta);
    return true;
  }
}

function selectEventFromTasks_(ev){
  // p≈ôepneme do tabulky, aby bylo jasn√©, co se vybralo (a aby ≈°el export/archiv)
  el('view_table').click();

  // vyplnit form
  SELECTED_EVENT_ID = ev.id;
  fillEventForm(ev);

  // naj√≠t a oznaƒçit ≈ô√°dek
  const rows = Array.from(document.querySelectorAll('#eventsTable tbody tr'));
  const row = rows.find(r => (r.firstElementChild && r.firstElementChild.textContent.trim() === String(ev.id)));
  if(row) setSel(row,'#eventsTable');

  // na mobilu: scroll na editor (a≈• ‚Äúneodroluje do ≈ôiti‚Äù)
  const edit = el('editCard');
  if(edit){
    edit.scrollIntoView({behavior:'smooth', block:'start'});
  }
}

/* ===== EVENTS ===== */
['f_from','f_to','f_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadEvents());
});

el('ev_export').onclick = ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(SELECTED_EVENT_ID)+'&'+authQuery();
};
el('ev_archive').onclick = async ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber term√≠n.'); return; }
  if(!confirm('Archivovat vybran√Ω term√≠n?')) return;

  const j = await apiFetch(API_URL+'?action=admin_event_archive&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({id:SELECTED_EVENT_ID})
  });
  if(!j.ok){ alert(j.error||'Archivace selhala'); return; }
  SELECTED_EVENT_ID='';
  await loadEvents();
  alert('Term√≠n p≈ôesunut do archivu.');
};

function renderTasks_(events){
  const win = Number(el('windowSel').value||30);
  const now = new Date();
  const maxDate = new Date(now.getTime() + win*24*60*60*1000);

  const upcoming = events
    .map(ev=>{
      const start = new Date(ev.start);
      return { ev, start, daysToStart: daysDiff_(now, start) };
    })
    .filter(x => x.start >= now && x.start <= maxDate)
    .sort((a,b)=>a.start-b.start);

  const tasks = upcoming
    .map(x=>{
      const s = semaforFor_(x.ev);
      return { ...x, s };
    })
    .filter(x => x.s.key === 'crit' || x.s.key === 'warn');

  const box = el('tasksBox');
  const sum = el('tasksSummary');

  if(!tasks.length){
    box.innerHTML = `<div class="muted">Ve v√Ωhledu ${win} dn≈Ø nen√≠ nic kritick√©ho. ‚úÖ</div>`;
    sum.textContent = `V√Ωhled ${win} dn≈Ø: ${upcoming.length} term√≠n≈Ø ¬∑ √∫koly: 0√ó kritick√©, 0√ó pozor`;
    return;
  }

  const crit = tasks.filter(t=>t.s.key==='crit').length;
  const warn = tasks.filter(t=>t.s.key==='warn').length;
  sum.textContent = `V√Ωhled ${win} dn≈Ø: ${upcoming.length} term√≠n≈Ø ¬∑ √∫koly: ${crit}√ó kritick√©, ${warn}√ó pozor`;

  box.innerHTML = '';
  tasks.forEach(t=>{
    const ev = t.ev;
    const cap = Number(ev.capacity||0);
    const taken = Number(ev.taken||0);
    const left = cap - taken;

    const igText =
`${ev.name}
üìÖ ${formatStartShort_(ev.start)}
üëß Voln√° m√≠sta: ${left}/${cap}
‚û°Ô∏è Rezervace: smyslokoutek.cz`;

    const div = document.createElement('div');
    div.className = 'task';
    div.innerHTML = `
      <div class="left">
        <div class="title">${t.s.badgeHtml} <span class="mono">${escapeHtml_(t.s.line)}</span></div>
        <div class="rec"><b>Doporuƒçen√≠:</b> ${escapeHtml_(t.s.rec)}</div>
        <div class="meta">${escapeHtml_(ev.name)} ¬∑ ${escapeHtml_(formatStartShort_(ev.start))} ¬∑ chyb√≠ ${left} m√≠st</div>
      </div>
      <div class="actions">
        <button class="alt" data-copy="1">Zkop√≠rovat text (IG/FB)</button>
        <button data-pick="1">Vybrat term√≠n</button>
      </div>
    `;
    div.querySelector('[data-copy="1"]').onclick = async ()=>{
      await copyText_(igText);
      div.querySelector('[data-copy="1"]').textContent = 'Zkop√≠rov√°no ‚úÖ';
      setTimeout(()=>div.querySelector('[data-copy="1"]').textContent='Zkop√≠rovat text (IG/FB)', 1500);
    };
    div.querySelector('[data-pick="1"]').onclick = ()=>selectEventFromTasks_(ev);
    box.appendChild(div);
  });
}

async function loadEvents(){
  // pokud jsme na ‚ÄúCo ≈ôe≈°it‚Äù, naƒçteme bez tabulky rychle; tabulka se stejnƒõ vykresl√≠ pro v√Ωbƒõr/export
  const tb=el('eventsTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="9">Naƒç√≠t√°m‚Ä¶</td></tr>';

  try{
    const p=new URLSearchParams({
      action:'admin_events_list',
      from: el('f_from').value||'',
      to: el('f_to').value||'',
      q: el('f_q').value||''
    });
    const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');
    EVENTS_CACHE = j.items || [];

    renderTasks_(EVENTS_CACHE);
    renderEvents(EVENTS_CACHE);
  }catch(e){
    tb.innerHTML=`<tr><td colspan="9" style="color:#dc2626">${escapeHtml_(e.message||String(e))}</td></tr>`;
    logDbg(String(e));
    el('tasksBox').innerHTML = `<div class="error">${escapeHtml_(e.message||String(e))}</div>`;
    el('tasksSummary').textContent = '';
  }
}

function renderEvents(items){
  const box=el('eventsTable').querySelector('tbody');
  SELECTED_EVENT_ID='';
  if(!items.length){ box.innerHTML='<tr><td colspan="9">≈Ω√°dn√© term√≠ny.</td></tr>'; return; }
  box.innerHTML='';

  // ≈ôadit vzestupnƒõ dle startu, aby ‚Äúkrizov√©‚Äù bylo naho≈ôe, ale z√°rove≈à chronologicky
  const sorted = [...items].sort((a,b)=> new Date(a.start) - new Date(b.start));

  sorted.forEach(ev=>{
    const tr=document.createElement('tr');

    const s = semaforFor_(ev);
    const recText = s.key==='crit' ? 'D√°t dnes post + story (p≈ôipomenout).' :
                    s.key==='warn' ? 'Podpo≈ôit v t√Ωdnu (post / stories / p≈ôipomenut√≠ ve skupin√°ch).' :
                    '‚Äî';

    tr.innerHTML=
      `<td>${escapeHtml_(ev.id)}</td>
       <td>${escapeHtml_(ev.name)}</td>
       <td>${escapeHtml_(formatStartShort_(ev.start))}</td>
       <td>${escapeHtml_(ev.capacity)}</td>
       <td>${escapeHtml_(ev.taken)}</td>
       <td>${s.badgeHtml}</td>
       <td class="mono">${escapeHtml_(s.line)}<div class="muted">${escapeHtml_(recText)}</div></td>
       <td>${escapeHtml_(ev.price)}</td>
       <td>${escapeHtml_(ev.sibling_discount)}</td>`;

    const onPick = ()=>{
      setSel(tr,'#eventsTable');
      SELECTED_EVENT_ID=ev.id;
      fillEventForm(ev);
      // mobil: skok na editor
      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        el('editCard').scrollIntoView({behavior:'smooth', block:'start'});
      }
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});

    box.appendChild(tr);
  });
}

function fillEventForm(ev){
  el('ev_id').value=ev.id||'';
  el('ev_name').value=ev.name||'';
  try{
    const d=new Date(ev.start);
    const pad=n=>String(n).padStart(2,'0');
    el('ev_start').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{}
  el('ev_duration').value=ev.duration||90;
  el('ev_capacity').value=ev.capacity||0;
  el('ev_price').value=ev.price||0;
  el('ev_sibling').value=ev.sibling_discount||0;
}

el('ev_reset').onclick = ()=>{
  SELECTED_EVENT_ID='';
  el('ev_id').value='';
  el('ev_name').value='';
  el('ev_start').value='';
  el('ev_duration').value=90;
  el('ev_capacity').value=12;
  el('ev_price').value=200;
  el('ev_sibling').value=20;
  el('ev_msg').textContent='';
  document.querySelectorAll('#eventsTable tbody tr').forEach(x=>x.classList.remove('sel'));
};

el('ev_save').onclick = async ()=>{
  const msg=el('ev_msg');
  msg.className='error';
  msg.textContent='';

  if(!el('ev_name').value.trim()){ msg.textContent='Vypl≈à n√°zev.'; return; }
  if(!el('ev_start').value){ msg.textContent='Vypl≈à datum a ƒças.'; return; }

  const payload={
    id: el('ev_id').value.trim(),
    name: el('ev_name').value.trim(),
    start: el('ev_start').value,
    duration: Number(el('ev_duration').value||90),
    capacity: Number(el('ev_capacity').value||0),
    price: Number(el('ev_price').value||0),
    sibling_discount: Number(el('ev_sibling').value||0)
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_event_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadEvents();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== P≈ôep√≠naƒçe ‚ÄúCo ≈ôe≈°it / Pohled‚Äù ===== */
el('view_tasks').onclick = ()=>{
  el('view_tasks').classList.add('active');
  el('view_table').classList.remove('active');
  el('tasksBox').style.display='grid';
  el('tasksSummary').style.display='block';
  el('tableBox').style.display='none';
  // na mobilu: aby se nezobrazoval ‚Äúrozjet√Ω‚Äù viewport po p≈ôepnut√≠
  requestAnimationFrame(()=>window.scrollTo({top:0,left:0,behavior:'auto'}));
};
el('view_table').onclick = ()=>{
  el('view_table').classList.add('active');
  el('view_tasks').classList.remove('active');
  el('tasksBox').style.display='none';
  el('tasksSummary').style.display='none';
  el('tableBox').style.display='block';
  requestAnimationFrame(()=>window.scrollTo({top:0,left:0,behavior:'auto'}));
};
el('windowSel').onchange = ()=>renderTasks_(EVENTS_CACHE);

/* ===== COUPONS ===== */
el('cp_delete').onclick = async ()=>{
  if(!SELECTED_COUPON_CODE){ alert('Vyber kupon.'); return; }
  const hard=confirm('Smazat trvale? (OK = hard delete, Zru≈°it = deaktivovat)');
  const j = await apiFetch(API_URL+'?action=admin_coupon_delete&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({code:SELECTED_COUPON_CODE,hard})
  });
  if(!j.ok){ alert(j.error||'Maz√°n√≠ selhalo'); return; }
  SELECTED_COUPON_CODE='';
  await loadCoupons();
  alert(hard?'Kupon smaz√°n.':'Kupon deaktivov√°n.');
};
async function loadCoupons(){
  const box=el('couponsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="7">Naƒç√≠t√°m‚Ä¶</td></tr>';
  try{
    const j = await apiFetch(API_URL+'?action=admin_coupons_list&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba naƒçten√≠');
    renderCoupons(j.items||[]);
  }catch(e){
    box.innerHTML=`<tr><td colspan="7" style="color:#dc2626">${escapeHtml_(e.message)}</td></tr>`;
    logDbg(String(e));
  }
}
function renderCoupons(items){
  const box=el('couponsTable').querySelector('tbody');
  SELECTED_COUPON_CODE='';
  if(!items.length){ box.innerHTML='<tr><td colspan="7">≈Ω√°dn√© kupony.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${escapeHtml_(c.code)}</td><td>${escapeHtml_(c.type)}</td><td>${escapeHtml_(c.value)}</td><td>${escapeHtml_(c.max_uses)}</td><td>${escapeHtml_(c.used)}</td><td>${escapeHtml_(c.min_qty)}</td><td>${escapeHtml_(c.active)}</td>`;

    const onPick = ()=>{
      setSel(tr,'#couponsTable');
      SELECTED_COUPON_CODE=c.code;
      fillCouponForm(c);
      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        tr.scrollIntoView({behavior:'smooth', block:'nearest'});
      }
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});

    box.appendChild(tr);
  });
}
function fillCouponForm(c){
  el('cp_code').value=c.code||'';
  el('cp_type').value=c.type||'amount';
  el('cp_value').value=c.value||0;
  el('cp_maxuses').value=c.max_uses||0;
  el('cp_minqty').value=c.min_qty||1;
  el('cp_events').value=c.events||'*';
  el('cp_stack').value=c.stack_with_siblings?'true':'false';
  el('cp_cap').value=c.max_discount||'';
  el('cp_from').value=(c.valid_from||'').split('T')[0]||'';
  el('cp_to').value=(c.valid_to||'').split('T')[0]||'';
  el('cp_active').value=(c.active?1:0);
  el('cp_note').value=c.note||'';
}
el('cp_reset').onclick = ()=>{
  SELECTED_COUPON_CODE='';
  el('cp_code').value='';
  el('cp_type').value='amount';
  el('cp_value').value='';
  el('cp_maxuses').value='';
  el('cp_minqty').value='';
  el('cp_events').value='*';
  el('cp_stack').value='true';
  el('cp_cap').value='';
  el('cp_from').value='';
  el('cp_to').value='';
  el('cp_active').value='1';
  el('cp_note').value='';
  el('cp_msg').textContent='';
  document.querySelectorAll('#couponsTable tbody tr').forEach(x=>x.classList.remove('sel'));
};
el('cp_save').onclick = async ()=>{
  const msg=el('cp_msg');
  msg.className='error';
  msg.textContent='';
  if(!el('cp_code').value.trim()){ msg.textContent='Vypl≈à k√≥d.'; return; }

  const payload={
    code: el('cp_code').value.trim().toUpperCase(),
    type: el('cp_type').value,
    value: Number(el('cp_value').value||0),
    max_uses: Number(el('cp_maxuses').value||0),
    min_qty: Number(el('cp_minqty').value||1),
    events: el('cp_events').value.trim()||'*',
    stack_with_siblings:(el('cp_stack').value==='true'),
    max_discount: el('cp_cap').value?Number(el('cp_cap').value):null,
    valid_from: el('cp_from').value||null,
    valid_to: el('cp_to').value||null,
    active: Number(el('cp_active').value||1),
    note: el('cp_note').value||''
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_coupon_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Ulo≈æen√≠ selhalo');
    await loadCoupons();
    msg.className='ok';
    msg.textContent='Ulo≈æeno.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== BOOKINGS ===== */
el('b_export').onclick = ()=>{
  const v=el('b_ev').value;
  if(!v){ alert('Vyber ud√°lost v rozbalovaƒçce.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(v)+'&'+authQuery();
};
['b_ev','b_from','b_to','b_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadBookings());
});

async function loadEventDropdown(){
  const j = await apiFetch(API_URL+'?action=admin_events_dropdown', { method:'GET' });
  if(j.ok){
    const sel=el('b_ev');
    sel.innerHTML='<option value="">(v≈°echny ud√°losti)</option>';
    (j.items||[]).forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id;
      o.textContent=it.label;
      sel.appendChild(o);
    });
  }
}
async function loadBookings(){
  const tb=el('bookingsTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="8">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const p=new URLSearchParams({
    action:'admin_bookings_list',
    eventId: el('b_ev').value||'',
    from: el('b_from').value||'',
    to: el('b_to').value||'',
    q: el('b_q').value||'',
    page:'1',
    pageSize:'200'
  });

  const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="8" style="color:#dc2626">'+escapeHtml_(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="8">≈Ω√°dn√© rezervace.</td></tr>';
    return;
  }

  (j.items||[]).forEach(bk=>{
    const tr=document.createElement('tr');

    let tsIso = '';
    try{
      const d = new Date(bk.ts);
      tsIso = !isNaN(d.getTime()) ? d.toISOString() : String(bk.ts||'');
    }catch{ tsIso = String(bk.ts||''); }

    tr.innerHTML=`<td>${escapeHtml_(new Date(bk.ts).toLocaleString('cs-CZ'))}</td><td>${escapeHtml_(bk.eventId)}</td><td>${escapeHtml_(bk.name||'')}</td>
      <td>${escapeHtml_(bk.email||'')}</td><td>${escapeHtml_(bk.phone||'')}</td><td>${escapeHtml_(bk.qty)}</td><td>${escapeHtml_(bk.payment||'')}</td><td>${escapeHtml_(bk.total||0)}</td>`;

    const onPick = ()=>{
      setSel(tr,'#bookingsTable');
      BOOKING_KEY = { ts: tsIso, eventId: bk.eventId };

      el('bk_name').value=bk.name||'';
      el('bk_qty').value=bk.qty||0;
      el('bk_phone').value=bk.phone||'';
      el('bk_email').value=bk.email||'';
      el('bk_payment').value=bk.payment||'cash';

      if(window.matchMedia && window.matchMedia('(max-width: 980px)').matches){
        el('bk_name').scrollIntoView({behavior:'smooth', block:'start'});
      }
    };

    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true});

    tb.appendChild(tr);
  });
}
el('bk_save').onclick = async ()=>{
  const msg=el('bk_msg');
  msg.className='error';
  msg.textContent='';
  if(!BOOKING_KEY){ msg.textContent='Nen√≠ vybran√Ω z√°znam.'; return; }

  const payload={
    ts: BOOKING_KEY.ts,
    eventId: BOOKING_KEY.eventId,
    name: el('bk_name').value.trim(),
    phone: el('bk_phone').value.trim(),
    email: el('bk_email').value.trim(),
    qty: Number(el('bk_qty').value||0),
    paymentMethod: el('bk_payment').value
  };

  const j = await apiFetch(API_URL+'?action=admin_booking_update&'+authQuery(), {
    method:'POST',
    body: JSON.stringify(payload)
  });

  if(!j.ok){
    msg.className='error';
    msg.textContent=j.error||'Ulo≈æen√≠ selhalo';
    return;
  }

  msg.className='ok';
  msg.textContent='Ulo≈æeno.';
  await loadBookings();
};

/* ===== ARCHIVE ===== */
async function loadArchive(){
  const tb=el('archiveTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="6">Naƒç√≠t√°m‚Ä¶</td></tr>';

  const j = await apiFetch(API_URL+'?action=admin_events_archive&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="6" style="color:#dc2626">'+escapeHtml_(j.error||'Chyba naƒçten√≠')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="6">Archiv je pr√°zdn√Ω.</td></tr>';
    return;
  }

  (j.items||[]).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${escapeHtml_(ev.id)}</td><td>${escapeHtml_(ev.name)}</td><td>${escapeHtml_(ev.start)}</td><td>${escapeHtml_(ev.capacity)}</td><td>${escapeHtml_(ev.taken)}</td><td>${escapeHtml_(ev.price)}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== START ===== */
async function startApp(){
  try{
    const j = await apiFetch(API_URL+'?action=session&'+authQuery(), { method:'GET' });
    if(!j.ok){ localStorage.removeItem('adm_token'); location.reload(); return; }
    el('loginCard').style.display='none';
    el('app').style.display='block';
    // default: ‚ÄúCo ≈ôe≈°it‚Äù
    el('view_tasks').click();
    await Promise.all([loadEventDropdown(), loadEvents(), loadCoupons(), loadBookings(), loadArchive()]);
    // iOS: obƒças pom≈Ø≈æe reflow po prvn√≠m paintu
    setTimeout(()=>window.scrollTo({top:0,left:0,behavior:'auto'}), 50);
  }catch(e){
    logDbg(String(e));
    localStorage.removeItem('adm_token');
    location.reload();
  }
}
if(localStorage.getItem('adm_token')) startApp();
</script>
</body>
</html>
