<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Smyslokoutek</title>

  <script>
    (function () {
      if (location.hostname.endsWith('.github.io')) {
        location.replace('https://admin.smyslokoutek.cz' + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <meta name="robots" content="noindex,nofollow">

  <style>
    :root{--ink:#111827;--muted:#6b7280;--card:#fff;--bg:#f9fafb;--brand:#111;--ok:#16a34a;--err:#dc2626}
    body{font-family:system-ui,-apple-system,Inter,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1180px;margin:40px auto;padding:20px}
    .card{background:var(--card);padding:18px 20px;margin-bottom:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    h1{font-size:22px;margin:0 0 16px} h2{font-size:18px;margin:0 0 10px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select,textarea{width:100%;padding:10px;margin-top:4px;border:1px solid #e5e7eb;border-radius:8px;font-size:15px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{margin-top:12px;padding:10px 16px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer; touch-action:manipulation}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .error{color:var(--err);margin-top:8px}
    .ok{color:var(--ok);margin-top:8px}
    nav{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    nav button{background:#e5e7eb;color:#111} nav button.active{background:#111;color:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px;margin-top:12px}
    th,td{border:1px solid #e5e7eb;padding:6px;text-align:left}
    th{background:#f3f4f6}
    tr:hover{background:#fafafa}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .sel{background:#fef3c7 !important}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff}
    .log{margin:10px 0;padding:10px;border-radius:8px;background:#fff;border:1px dashed #e5e7eb;font:12px/1.5 ui-monospace,Menlo,monospace;max-height:160px;overflow:auto;white-space:pre-wrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Admin – Smyslokoutek</h1>

  <div id="loginCard" class="card">
    <div id="stepEmail">
      <label>Zadejte e-mail</label>
      <input id="email" type="email" placeholder="např. info@smyslokoutek.cz" />
      <button id="sendOtpBtn">Poslat kód</button>
      <div id="msgEmail" class="error"></div>
    </div>
    <div id="stepOtp" style="display:none">
      <label>Zadejte kód z e-mailu</label>
      <input id="otp" type="text" placeholder="6místný kód" />
      <button id="verifyOtpBtn">Přihlásit</button>
      <div id="msgOtp" class="error"></div>
    </div>
    <div id="debug" class="log" style="display:none"></div>
  </div>

  <div id="app" style="display:none">
    <nav>
      <button data-tab="events" class="active">Termíny</button>
      <button data-tab="coupons">Kupony</button>
      <button data-tab="bookings">Rezervace</button>
      <button data-tab="archive">Archiv</button>
      <div class="right" style="margin-left:auto"><button id="logoutBtn">Odhlásit</button></div>
    </nav>

    <div id="tab-events">
      <div class="grid">
        <div class="card">
          <h2>Seznam termínů</h2>
          <div class="toolbar">
            <input id="f_from" type="date" />
            <input id="f_to" type="date" />
            <input id="f_q" placeholder="Hledat v ID / názvu" style="flex:1" />
            <button id="ev_export">Export rezervací</button>
            <button id="ev_archive">Archivovat</button>
          </div>
          <div class="muted">Kliknutím vybereš termín pro úpravu / export / archivaci.</div>
          <table id="eventsTable"><thead><tr>
            <th>ID</th><th>Název</th><th>Start</th><th>Kap.</th><th>Obs.</th><th>Cena</th><th>Sleva souroz.</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Nový / úprava termínu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Events</span>.</div>
          <label>ID</label><input id="ev_id" />
          <label>Název</label><input id="ev_name" />
          <div class="row">
            <div><label>Start</label><input id="ev_start" type="datetime-local" /></div>
            <div><label>Délka (min)</label><input id="ev_duration" type="number" value="90" /></div>
          </div>
          <div class="row">
            <div><label>Kapacita</label><input id="ev_capacity" type="number" value="12" /></div>
            <div><label>Cena (Kč)</label><input id="ev_price" type="number" value="200" /></div>
          </div>
          <label>Sleva pro sourozence</label><input id="ev_sibling" type="number" value="20" />
          <div class="right"><button id="ev_reset">Vymazat</button><button id="ev_save">Uložit</button></div>
          <div id="ev_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-coupons" style="display:none">
      <div class="grid">
        <div class="card">
          <h2>Seznam kuponů</h2>
          <div class="right"><button id="cp_delete">Smazat / deaktivovat</button></div>
          <div class="muted">Klikni na kupon pro úpravu (a pro smazání/deaktivaci).</div>
          <table id="couponsTable"><thead><tr>
            <th>Kód</th><th>Typ</th><th>Hodnota</th><th>Max použ.</th><th>Vyčerpáno</th><th>Min qty</th><th>Aktivní</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Nový / úprava kuponu</h2>
          <div class="muted">Zapisuje se do <span class="pill">Coupons</span>.</div>
          <label>Kód</label><input id="cp_code" />
          <div class="row">
            <div><label>Typ</label>
              <select id="cp_type">
                <option value="amount">amount (Kč)</option>
                <option value="percent">percent (%)</option>
                <option value="free">free (počet míst)</option>
                <option value="bogo">bogo (1+1, qty=2)</option>
              </select>
            </div>
            <div><label>Hodnota</label><input id="cp_value" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Max. použití</label><input id="cp_maxuses" type="number" /></div>
            <div><label>Min. qty</label><input id="cp_minqty" type="number" /></div>
          </div>
          <label>Události (id, * = všechny)</label><input id="cp_events" />
          <div class="row">
            <div><label>Stack se sourozenci?</label><select id="cp_stack"><option value="true">TRUE</option><option value="false">FALSE</option></select></div>
            <div><label>Max sleva (jen pro %)</label><input id="cp_cap" type="number" /></div>
          </div>
          <div class="row">
            <div><label>Platnost od</label><input id="cp_from" type="date" /></div>
            <div><label>Platnost do</label><input id="cp_to" type="date" /></div>
          </div>
          <label>Aktivní</label><select id="cp_active"><option value="1">1</option><option value="0">0</option></select>
          <label>Poznámka</label><input id="cp_note" />
          <div class="right"><button id="cp_reset">Vymazat</button><button id="cp_save">Uložit</button></div>
          <div id="cp_msg" class="error"></div>
        </div>
      </div>
    </div>

    <div id="tab-bookings" style="display:none">
      <div class="card">
        <h2>Rezervace</h2>
        <div class="toolbar">
          <select id="b_ev" style="min-width:320px"><option value="">(všechny události)</option></select>
          <input id="b_from" type="date" />
          <input id="b_to" type="date" />
          <input id="b_q" placeholder="Hledat (jméno, e-mail, tel.)" style="flex:1" />
          <button id="b_export">Export aktuálního výběru</button>
        </div>
        <table id="bookingsTable"><thead><tr>
          <th>TS</th><th>Event</th><th>Jméno</th><th>Email</th><th>Tel</th><th>Míst</th><th>Platba</th><th>Celkem</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h2>Upravit rezervaci</h2>
        <div class="muted">Klikni v tabulce na řádek – záznam se načte sem.</div>
        <div class="row">
          <div><label>Jméno</label><input id="bk_name"/></div>
          <div><label>Qty</label><input id="bk_qty" type="number" min="0"/></div>
        </div>
        <div class="row">
          <div><label>Telefon</label><input id="bk_phone"/></div>
          <div><label>E-mail</label><input id="bk_email"/></div>
        </div>
        <label>Platba</label>
        <select id="bk_payment"><option value="cash">cash</option><option value="transfer">transfer</option></select>
        <div class="right"><button id="bk_save">Uložit změny</button></div>
        <div id="bk_msg" class="error"></div>
      </div>
    </div>

    <div id="tab-archive" style="display:none">
      <div class="card">
        <h2>Archiv termínů</h2>
        <table id="archiveTable"><thead><tr>
          <th>ID</th><th>Název</th><th>Start</th><th>Kapacita</th><th>Obsazeno</th><th>Cena</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>

  </div>
</div>

<script>
/* ===== KONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzAJh9wVawvTfLUfsi7qqtkxyaT5Hpm69gyAlwNROW8N5S-MEIrOSW541caGaRQ5ysl_g/exec';
if(!API_URL || !API_URL.includes('/exec')){ alert('Chybí platná API_URL!'); }

/* ===== HELPERY ===== */
const el = id => document.getElementById(id);
const errEmail = el('msgEmail'), errOtp = el('msgOtp'), dbg = el('debug');
function authQuery(){
  const t = localStorage.getItem('adm_token') || '';
  return 'Authorization=' + encodeURIComponent('Bearer ' + t);
}
function setSel(tr, tableSel){
  document.querySelectorAll(`${tableSel} tbody tr`).forEach(x=>x.classList.remove('sel'));
  tr.classList.add('sel');
}
function logDbg(obj){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.textContent = typeof obj==='string' ? obj : JSON.stringify(obj,null,2); }
  catch{ dbg.textContent = String(obj); }
}

/* ===== FETCH WRAPPER (iOS hardening) ===== */
function withCacheBust(url){
  const u = new URL(url, location.href);
  u.searchParams.set('_', String(Date.now()));
  return u.toString();
}
async function apiFetch(url, opts={}){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), opts.timeoutMs || 20000);

  try{
    const r = await fetch(withCacheBust(url), {
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow',
      ...opts,
      headers: { 'Content-Type':'text/plain; charset=utf-8', ...(opts.headers||{}) },
      signal: controller.signal
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{ j = { ok:false, error:'Neplatná odpověď serveru', raw: txt }; }
    return j;
  } finally {
    clearTimeout(t);
  }
}

/* ===== OTP ===== */
el('sendOtpBtn').onclick = async ()=>{
  const email = el('email').value.trim().toLowerCase();
  errEmail.textContent=''; logDbg('');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errEmail.textContent='Zadejte platný e-mail.'; return; }
  const b=el('sendOtpBtn'); b.disabled=true; b.textContent='Odesílám…';
  try{
    const j = await apiFetch(API_URL+'?action=auth_request_otp', { method:'POST', body: JSON.stringify({email}) });
    logDbg(j);
    if(!j.ok){ errEmail.textContent=j.error||'Nepodařilo se odeslat kód.'; return; }
    el('stepEmail').style.display='none';
    el('stepOtp').style.display='block';
    errOtp.textContent='Kód odeslán (platí 5 min).';
  }catch(e){
    errEmail.textContent='Chyba sítě – zkuste znovu.';
    logDbg(String(e));
  }finally{
    setTimeout(()=>{ b.disabled=false; b.textContent='Poslat kód'; }, 30000);
  }
};
el('verifyOtpBtn').onclick = async ()=>{
  const email=el('email').value.trim().toLowerCase();
  const code=el('otp').value.trim();
  errOtp.textContent=''; logDbg('');
  try{
    const j = await apiFetch(API_URL+'?action=auth_verify_otp', { method:'POST', body: JSON.stringify({email,code}) });
    logDbg(j);
    if(!j.ok){ errOtp.textContent=j.error||'Chybný kód.'; return; }
    localStorage.setItem('adm_token', j.token);
    startApp();
  }catch(e){
    errOtp.textContent='Chyba sítě – zkuste znovu.';
    logDbg(String(e));
  }
};

/* ===== NAV ===== */
document.querySelectorAll('nav button[data-tab]').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('[id^=tab-]').forEach(x=>x.style.display='none');
    el('tab-'+b.dataset.tab).style.display='block';
  };
});
el('logoutBtn').onclick = ()=>{ localStorage.removeItem('adm_token'); location.reload(); };

/* ===== STATE ===== */
let SELECTED_EVENT_ID='';
let SELECTED_COUPON_CODE='';
let BOOKING_KEY=null;

/* ===== EVENTS ===== */
['f_from','f_to','f_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadEvents());
});

el('ev_export').onclick = ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber termín.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(SELECTED_EVENT_ID)+'&'+authQuery();
};
el('ev_archive').onclick = async ()=>{
  if(!SELECTED_EVENT_ID){ alert('Vyber termín.'); return; }
  if(!confirm('Archivovat vybraný termín?')) return;

  const j = await apiFetch(API_URL+'?action=admin_event_archive&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({id:SELECTED_EVENT_ID})
  });
  if(!j.ok){ alert(j.error||'Archivace selhala'); return; }
  SELECTED_EVENT_ID='';
  await loadEvents();
  alert('Termín přesunut do archivu.');
};

async function loadEvents(){
  const box=el('eventsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="7">Načítám…</td></tr>';

  try{
    const p=new URLSearchParams({
      action:'admin_events_list',
      from: el('f_from').value||'',
      to: el('f_to').value||'',
      q: el('f_q').value||''
    });
    const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba načtení');
    renderEvents(j.items||[]);
  }catch(e){
    box.innerHTML=`<tr><td colspan="7" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}
function renderEvents(items){
  const box=el('eventsTable').querySelector('tbody');
  SELECTED_EVENT_ID='';
  if(!items.length){ box.innerHTML='<tr><td colspan="7">Žádné termíny.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ev.id}</td><td>${ev.name}</td><td>${ev.start}</td><td>${ev.capacity}</td><td>${ev.taken}</td><td>${ev.price}</td><td>${ev.sibling_discount}</td>`;

    const onPick = ()=>{
      setSel(tr,'#eventsTable');
      SELECTED_EVENT_ID=ev.id;
      fillEventForm(ev);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true}); // iOS fallback

    box.appendChild(tr);
  });
}
function fillEventForm(ev){
  el('ev_id').value=ev.id||'';
  el('ev_name').value=ev.name||'';
  try{
    const d=new Date(ev.start);
    const pad=n=>String(n).padStart(2,'0');
    el('ev_start').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }catch{}
  el('ev_duration').value=ev.duration||90;
  el('ev_capacity').value=ev.capacity||0;
  el('ev_price').value=ev.price||0;
  el('ev_sibling').value=ev.sibling_discount||0;
}
el('ev_save').onclick = async ()=>{
  const msg=el('ev_msg');
  msg.className='error';
  msg.textContent='';

  if(!el('ev_name').value.trim()){ msg.textContent='Vyplň název.'; return; }
  if(!el('ev_start').value){ msg.textContent='Vyplň datum a čas.'; return; }

  const payload={
    id: el('ev_id').value.trim(),
    name: el('ev_name').value.trim(),
    start: el('ev_start').value, // datetime-local string
    duration: Number(el('ev_duration').value||90),
    capacity: Number(el('ev_capacity').value||0),
    price: Number(el('ev_price').value||0),
    sibling_discount: Number(el('ev_sibling').value||0)
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_event_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Uložení selhalo');
    await loadEvents();
    msg.className='ok';
    msg.textContent='Uloženo.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== COUPONS ===== */
el('cp_delete').onclick = async ()=>{
  if(!SELECTED_COUPON_CODE){ alert('Vyber kupon.'); return; }
  const hard=confirm('Smazat trvale? (OK = hard delete, Zrušit = deaktivovat)');
  const j = await apiFetch(API_URL+'?action=admin_coupon_delete&'+authQuery(), {
    method:'POST',
    body: JSON.stringify({code:SELECTED_COUPON_CODE,hard})
  });
  if(!j.ok){ alert(j.error||'Mazání selhalo'); return; }
  SELECTED_COUPON_CODE='';
  await loadCoupons();
  alert(hard?'Kupon smazán.':'Kupon deaktivován.');
};
async function loadCoupons(){
  const box=el('couponsTable').querySelector('tbody');
  box.innerHTML='<tr><td colspan="7">Načítám…</td></tr>';
  try{
    const j = await apiFetch(API_URL+'?action=admin_coupons_list&'+authQuery(), { method:'GET' });
    if(!j.ok) throw new Error(j.error||'Chyba načtení');
    renderCoupons(j.items||[]);
  }catch(e){
    box.innerHTML=`<tr><td colspan="7" style="color:#dc2626">${e.message}</td></tr>`;
    logDbg(String(e));
  }
}
function renderCoupons(items){
  const box=el('couponsTable').querySelector('tbody');
  SELECTED_COUPON_CODE='';
  if(!items.length){ box.innerHTML='<tr><td colspan="7">Žádné kupony.</td></tr>'; return; }
  box.innerHTML='';
  items.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.code}</td><td>${c.type}</td><td>${c.value}</td><td>${c.max_uses}</td><td>${c.used}</td><td>${c.min_qty}</td><td>${c.active}</td>`;

    const onPick = ()=>{
      setSel(tr,'#couponsTable');
      SELECTED_COUPON_CODE=c.code;
      fillCouponForm(c);
    };
    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true}); // iOS fallback

    box.appendChild(tr);
  });
}
function fillCouponForm(c){
  el('cp_code').value=c.code||'';
  el('cp_type').value=c.type||'amount';
  el('cp_value').value=c.value||0;
  el('cp_maxuses').value=c.max_uses||0;
  el('cp_minqty').value=c.min_qty||1;
  el('cp_events').value=c.events||'*';
  el('cp_stack').value=c.stack_with_siblings?'true':'false';
  el('cp_cap').value=c.max_discount||'';
  el('cp_from').value=(c.valid_from||'').split('T')[0]||'';
  el('cp_to').value=(c.valid_to||'').split('T')[0]||'';
  el('cp_active').value=(c.active?1:0);
  el('cp_note').value=c.note||'';
}
el('cp_save').onclick = async ()=>{
  const msg=el('cp_msg');
  msg.className='error';
  msg.textContent='';
  if(!el('cp_code').value.trim()){ msg.textContent='Vyplň kód.'; return; }

  const payload={
    code: el('cp_code').value.trim().toUpperCase(),
    type: el('cp_type').value,
    value: Number(el('cp_value').value||0),
    max_uses: Number(el('cp_maxuses').value||0),
    min_qty: Number(el('cp_minqty').value||1),
    events: el('cp_events').value.trim()||'*',
    stack_with_siblings:(el('cp_stack').value==='true'),
    max_discount: el('cp_cap').value?Number(el('cp_cap').value):null,
    valid_from: el('cp_from').value||null,
    valid_to: el('cp_to').value||null,
    active: Number(el('cp_active').value||1),
    note: el('cp_note').value||''
  };

  try{
    const j = await apiFetch(API_URL+'?action=admin_coupon_upsert&'+authQuery(), { method:'POST', body: JSON.stringify(payload) });
    if(!j.ok) throw new Error(j.error||'Uložení selhalo');
    await loadCoupons();
    msg.className='ok';
    msg.textContent='Uloženo.';
  }catch(e){
    msg.className='error';
    msg.textContent=String(e);
    logDbg(String(e));
  }
};

/* ===== BOOKINGS ===== */
el('b_export').onclick = ()=>{
  const v=el('b_ev').value;
  if(!v){ alert('Vyber událost v rozbalovačce.'); return; }
  window.location.href = API_URL+'?action=admin_bookings_export&eventId='+encodeURIComponent(v)+'&'+authQuery();
};
['b_ev','b_from','b_to','b_q'].forEach(id=>{
  const x=el(id);
  if(x) x.addEventListener('input', ()=>loadBookings());
});

async function loadEventDropdown(){
  const j = await apiFetch(API_URL+'?action=admin_events_dropdown', { method:'GET' });
  if(j.ok){
    const sel=el('b_ev');
    sel.innerHTML='<option value="">(všechny události)</option>';
    (j.items||[]).forEach(it=>{
      const o=document.createElement('option');
      o.value=it.id;
      o.textContent=it.label;
      sel.appendChild(o);
    });
  }
}
async function loadBookings(){
  const tb=el('bookingsTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="8">Načítám…</td></tr>';

  const p=new URLSearchParams({
    action:'admin_bookings_list',
    eventId: el('b_ev').value||'',
    from: el('b_from').value||'',
    to: el('b_to').value||'',
    q: el('b_q').value||'',
    page:'1',
    pageSize:'200'
  });

  const j = await apiFetch(API_URL+'?'+p.toString()+'&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="8" style="color:#dc2626">'+(j.error||'Chyba načtení')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="8">Žádné rezervace.</td></tr>';
    return;
  }

  (j.items||[]).forEach(bk=>{
    const tr=document.createElement('tr');

    // ✅ očekáváme ISO string (po doporučené úpravě Apps Scriptu); když ne, zkusíme normalizovat
    let tsIso = '';
    try{
      const d = new Date(bk.ts);
      tsIso = !isNaN(d.getTime()) ? d.toISOString() : String(bk.ts||'');
    }catch{ tsIso = String(bk.ts||''); }

    tr.innerHTML=`<td>${new Date(bk.ts).toLocaleString('cs-CZ')}</td><td>${bk.eventId}</td><td>${bk.name||''}</td>
      <td>${bk.email||''}</td><td>${bk.phone||''}</td><td>${bk.qty}</td><td>${bk.payment||''}</td><td>${bk.total||0}</td>`;

    const onPick = ()=>{
      setSel(tr,'#bookingsTable');
      BOOKING_KEY = { ts: tsIso, eventId: bk.eventId };

      el('bk_name').value=bk.name||'';
      el('bk_qty').value=bk.qty||0;
      el('bk_phone').value=bk.phone||'';
      el('bk_email').value=bk.email||'';
      el('bk_payment').value=bk.payment||'cash';
    };

    tr.addEventListener('click', onPick, {passive:true});
    tr.addEventListener('pointerup', onPick, {passive:true}); // iOS fallback

    tb.appendChild(tr);
  });
}
el('bk_save').onclick = async ()=>{
  const msg=el('bk_msg');
  msg.className='error';
  msg.textContent='';
  if(!BOOKING_KEY){ msg.textContent='Není vybraný záznam.'; return; }

  const payload={
    ts: BOOKING_KEY.ts,
    eventId: BOOKING_KEY.eventId,
    name: el('bk_name').value.trim(),
    phone: el('bk_phone').value.trim(),
    email: el('bk_email').value.trim(),
    qty: Number(el('bk_qty').value||0),
    paymentMethod: el('bk_payment').value
  };

  const j = await apiFetch(API_URL+'?action=admin_booking_update&'+authQuery(), {
    method:'POST',
    body: JSON.stringify(payload)
  });

  if(!j.ok){
    msg.className='error';
    msg.textContent=j.error||'Uložení selhalo';
    return;
  }

  msg.className='ok';
  msg.textContent='Uloženo.';
  await loadBookings();
};

/* ===== ARCHIVE ===== */
async function loadArchive(){
  const tb=el('archiveTable').querySelector('tbody');
  tb.innerHTML='<tr><td colspan="6">Načítám…</td></tr>';

  const j = await apiFetch(API_URL+'?action=admin_events_archive&'+authQuery(), { method:'GET' });
  if(!j.ok){
    tb.innerHTML='<tr><td colspan="6" style="color:#dc2626">'+(j.error||'Chyba načtení')+'</td></tr>';
    return;
  }

  tb.innerHTML='';
  if(!(j.items||[]).length){
    tb.innerHTML='<tr><td colspan="6">Archiv je prázdný.</td></tr>';
    return;
  }

  (j.items||[]).forEach(ev=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ev.id}</td><td>${ev.name}</td><td>${ev.start}</td><td>${ev.capacity}</td><td>${ev.taken}</td><td>${ev.price}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== START ===== */
async function startApp(){
  try{
    const j = await apiFetch(API_URL+'?action=session&'+authQuery(), { method:'GET' });
    if(!j.ok){ localStorage.removeItem('adm_token'); location.reload(); return; }
    el('loginCard').style.display='none';
    el('app').style.display='block';
    await Promise.all([loadEventDropdown(), loadEvents(), loadCoupons(), loadBookings(), loadArchive()]);
  }catch(e){
    logDbg(String(e));
    localStorage.removeItem('adm_token');
    location.reload();
  }
}
if(localStorage.getItem('adm_token')) startApp();
</script>
</body>
</html>
